# 第一章：金融机器学习作为一个独立的学科

## 1.1 动机

机器学习（ML）正在改变我们生活的几乎每个方面。今天，机器学习算法可以完成直到最近只有专业人士才能完成的任务。与金融相关，这是采用一种颠覆性技术的最激动人心的时刻，这将改变每个人在未来几代人的投资方式。这本书解释了在我二十年的职业生涯中使用的科学合理的机器学习工具，帮助我管理一些最苛刻的机构投资者的大量资金。

关于投资的书籍大致可分为两类。一方面，我们发现一些书籍的作者并没有实践他们所教授的内容。这些书籍包含了极其优雅的数学，描述了一个并不存在的世界。一个定理在逻辑上是真实的，并不意味着它在物理上也是真实的。另一方面，我们也看到一些书籍的作者提供的解释缺乏任何严谨的学术理论。他们错误使用数学工具来描述实际观察。他们的模型过拟合，在实施时失败。学术研究和出版与金融市场的实际应用脱节，而在交易/投资领域的许多应用并没有基于适当的科学。

写这本书的首要动机是为了跨越学术界与行业之间的隐喻鸿沟。我曾在这两方面都有所经历，因此我了解跨越这一鸿沟有多么困难，以及在一侧固守有多么容易。美德在于平衡。这本书不会仅仅因为某个理论在数学上美观而加以倡导，也不会仅仅因为某个解决方案看起来有效而提出。我希望传递的是那种仅来自经验的知识，并以严谨的方式加以形式化。

第二个动机源于希望金融能服务于某种目的。多年来，我在学术期刊和报纸上发表的一些文章表达了我对金融在我们社会中当前角色的不满。投资者被诱导将财富押注于来自江湖骗子的荒谬猜测，并受到大众媒体的鼓励。在不久的将来，机器学习将主导金融，科学将限制猜测，投资不再意味着赌博。我希望读者能在这场革命中发挥一份力量。

第三个动机是许多投资者未能理解机器学习应用于投资的复杂性。这在向“量化基本面”领域转型的自由裁量公司中尤其明显。我担心他们的高期望将无法实现，这并不是因为机器学习失败，而是因为他们错误地使用了机器学习。在未来几年中，许多公司将使用从学术界或硅谷直接引进的现成机器学习算法进行投资，我的预测是，他们将因此亏损（相较于更好的机器学习解决方案）。战胜群体智慧比识别面孔或驾驶汽车要困难得多。通过这本书，我希望你能学会解决一些使金融成为机器学习特别困难的挑战，比如回测过拟合。金融机器学习是一个独立的主题，虽然与标准机器学习有关但又有所不同，这本书将为你解开这一主题。

## 1.2 金融机器学习项目通常失败的主要原因

定量金融的失败率很高，尤其是在金融机器学习领域。少数成功者积累了大量资产，并持续为投资者提供卓越的业绩。然而，这是一种罕见的结果，原因在本书中有说明。在过去的二十年中，我见过许多面孔来来往往，许多公司创立又关闭。根据我的经验，所有这些失败的根本原因在于一个关键错误。

**1.2.1 西西弗斯范式**

自由裁量投资组合经理（PMs）做出的投资决策并不遵循特定的理论或理由（如果有，他们就是系统性 PMs）。他们消费原始新闻和分析，但主要依赖于自己的判断或直觉。他们可能根据某个故事来合理化这些决策，但每个决策背后总有一个故事。因为没有人完全理解他们下注背后的逻辑，投资公司要求他们彼此独立工作，形成孤岛，以确保多样化。如果你曾经参加过自由裁量 PM 的会议，可能会注意到它们是多么漫长而无目的。每位与会者似乎对某个特定的轶事信息着迷，并在没有基于事实的实证证据的情况下做出巨大的争论跳跃。这并不意味着自由裁量 PM 不能成功。相反，其中一些确实能成功。关键是，他们不能自然地作为一个团队工作。把 50 个自由裁量 PM 放在一起，他们会互相影响，最终你为一人的工作支付 50 份薪水。因此，他们在孤岛中工作是有意义的，以尽量减少互动。

无论我在哪些定量或机器学习项目中看到这个公式的应用，最终都导致了灾难。董事会的心态是，让我们对定量分析师做与自由裁量基金经理相同的事情。让我们雇佣 50 名博士，并要求每个人在六个月内提出一个投资策略。这种方法总是适得其反，因为每位博士都会疯狂寻找投资机会，最终只能满足于（1）在过度拟合回测中看起来不错的假阳性，或（2）标准因子投资，这是一种竞争激烈且夏普比率低的策略，但至少有学术支持。这两种结果都会让投资委员会失望，项目将被取消。即使其中 5 名博士发现了真正的机会，利润也不足以覆盖 50 人的费用，因此这 5 人会转向其他地方，寻找适当的回报。

**1.2.2 元策略范式**

如果你被要求独自开发机器学习策略，胜算对你来说几乎是微乎其微的。产生一个真实投资策略所需的努力几乎与产生一百个相同，而复杂性是压倒性的：数据整理和处理、高性能计算基础设施、软件开发、特征分析、执行模拟器、回测等。即使公司在这些领域提供共享服务，你就像在 BMW 工厂工作的工人，被要求利用周围的所有车间建造一辆完整的汽车。一周你需要成为一名熟练的焊工，另一周成为电工，再一周成为机械工程师，又一周成为油漆工……你会尝试、失败，然后回到焊接。这样有什么意义呢？

我所了解的每一家成功的定量公司都应用了元策略范式（López de Prado [2014]）。因此，这本书是为团队而非个人编写的研究手册。通过本书的章节，你将学习如何建立一个研究工厂，以及装配线的各个站点。每个量化分析师的角色是专注于特定任务，成为该领域的最佳，同时对整个过程有整体的看法。这本书概述了工厂计划，其中团队合作以可预测的速度产生发现，而不依赖于运气。这就是伯克利实验室和其他美国国家实验室如何定期进行科学发现的方式，比如向元素周期表中添加 16 种元素，或为 MRI 和 PET 扫描奠定基础。^(1) 没有特定个人对这些发现负责，因为它们是团队努力的结果，每个人都有所贡献。当然，建立这些金融实验室需要时间，并且需要那些知道自己在做什么并且曾经做过的人。但你认为，这种经过验证的有组织合作范式成功的可能性更高，还是每个量化分析师像西西弗斯一样把巨石推上山的徒劳替代方式更高？

## 1.3 书籍结构

这本书解开了一系列相互关联的话题，并将其以有序的方式呈现。每一章都假设你已经阅读了前面的内容。第一部分将帮助你以适合机器学习（ML）算法的方式结构化你的财务数据。第二部分讨论如何使用这些数据进行机器学习算法研究。这里强调的是通过科学过程进行研究并取得实际发现，而不是无目的地搜索直到出现某个偶然（可能是错误的）结果。第三部分解释了如何对你的发现进行回测，并评估其错误的可能性。

这三个部分概述了整个过程，从数据分析到模型研究再到发现评估。有了这些知识，第四部分回到数据，解释创新的方法以提取信息特征。最后，这项工作需要大量的计算能力，因此第五部分用一些有用的高性能计算食谱结束本书。

**1.3.1 按生产链结构**

在 16 世纪和 17 世纪，开采黄金或白银是一项相对简单的事业。在不到一百年的时间里，西班牙的财富舰队使欧洲流通的贵金属数量增加了四倍。那样的时代早已过去，今天的勘探者必须采用复杂的工业方法，从吨土中提取微小的金属颗粒。但这并不意味着黄金生产处于历史低点。相反，如今矿工每年提取 2,500 公吨的微观黄金，而西班牙征服者在整个 16 世纪的平均年产量仅为 1.54 公吨！^(2) 可见的黄金只是地球上黄金总量的微不足道的一部分。*埃尔多拉多*一直存在……如果皮萨罗能用显微镜交换他的剑就好了。

投资策略的发现经历了类似的演变。如果说十年前个人发现宏观阿尔法（即使用简单的数学工具如计量经济学）相对普遍，那么目前这种机会正在迅速接近于零。如今，无论经验或知识如何，个人在寻找宏观阿尔法时都面临巨大的困难。唯一真正的阿尔法是微观的，找到它需要资本密集型的工业方法。就像黄金一样，微观阿尔法并不意味着整体利润更小。今天的微观阿尔法比历史上任何时候的宏观阿尔法都要丰富得多。这里有很多钱可赚，但你需要使用强大的机器学习工具。

让我们回顾一下现代资产管理公司生产链中涉及的一些环节。

***1.3.1.1 数据策展人***

这是负责收集、清理、索引、存储、调整和将所有数据传递给生产链的站点。数据的值可以是表格形式或分层结构、对齐或不对齐、历史数据或实时数据馈送等。团队成员是市场微观结构和数据协议（如 FIX）方面的专家。他们必须开发数据处理程序，以理解数据出现的上下文。例如，报价是被取消并在不同级别替换，还是被取消而没有替换？每个资产类别都有其自身的细微差别。例如，债券通常被交换或召回；股票受到拆分、反向拆分、投票权等的影响；期货和期权必须进行滚动；货币不在集中订单簿中交易。这个站点所涉及的专业化程度超出了本书的范围，第一章将仅讨论数据策展的几个方面。

***1.3.1.2 特征分析师***

这是负责将原始数据转换为信息信号的站点。这些信息信号对金融变量具有一定的预测能力。团队成员是信息理论、信号提取与处理、可视化、标注、加权、分类器和特征重要性技术方面的专家。例如，特征分析师可能会发现，当以下情况发生时，抛售的概率特别高：(1) 报价被取消—替换为市场卖单，(2) 报价买单被取消—替换为在深层订单簿中的限价买单。这种发现本身并不是一种投资策略，可以以不同方式使用：执行、流动性风险监测、做市、建仓等。一个常见的错误是认为特征分析师会制定策略。相反，特征分析师收集和分类可以对多个站点有用的发现库。第 2-9 章和第 17-19 章专门讨论这个至关重要的站点。

***1.3.1.3 策略师***

在本站，信息特征被转化为实际的投资算法。战略家将遍历特征库，寻找开发投资策略的创意。这些特征是不同分析师研究广泛的工具和资产类别时发现的。战略家的目标是理解所有这些观察结果，并制定一个解释它们的通用理论。因此，策略仅仅是为验证该理论的有效性而设计的实验。团队成员是对金融市场和经济有深入了解的数据科学家。请记住，理论需要解释大量重要特征。特别是，理论必须识别导致代理人向我们亏损的经济机制。这是行为偏见？不对称信息？监管约束？特征可能由黑箱发现，但策略是在白箱中开发的。将多个目录特征拼凑在一起并不构成理论。一旦策略最终确定，战略家将准备利用完整算法的代码，并将该原型提交给下述回测团队。第十章和第十六章专门讨论本站，理解书中揭示具体投资策略是不合理的。

***1.3.1.4 回测者***

本站评估投资策略在各种情境下的盈利能力。一个感兴趣的情境是如果历史重演，策略将如何表现。然而，历史路径仅仅是随机过程可能结果之一，并不一定是未来最可能的结果。必须评估替代情境，考虑到对所提议策略的优缺点的了解。团队成员是对经验和实验技术有深入理解的数据科学家。一位优秀的回测者在分析中融入有关策略形成过程的元信息。特别是，他的分析必须考虑用于提炼策略所需的试验次数，以评估回测过拟合的概率。这一评估的结果不会被其他站点重用，原因将在第十一章中显现。相反，回测结果会传达给管理层，不会与其他人分享。第 11 至 16 章讨论了本站进行的分析。

***1.3.1.5 部署团队***

部署团队的任务是将策略代码集成到生产线中。有些组件可能会被多个策略重用，特别是在它们共享共同特征时。团队成员是算法专家和核心数学程序员。他们的部分工作是确保已部署的解决方案在逻辑上与他们接收到的原型相同。部署团队还需优化实现，以确保生产延迟最小化。由于生产计算通常是时间敏感的，该团队将大量依赖过程调度器、自动化服务器（Jenkins）、向量化、多线程、多处理、图形处理单元（GPU-NVIDIA）、分布式计算（Hadoop）、高性能计算（Slurm）以及一般并行计算技术。第 20-22 章涉及与此阶段相关的金融机器学习的各种有趣方面。

***1.3.1.6 投资组合监督***

一旦策略被部署，它将遵循一个*cursus honorum*，包括以下阶段或生命周期：

1.  **禁运**：最初，策略在回测结束日期之后观察到的数据上运行。这一时期可能是回测人员保留的，或是实施延迟的结果。如果禁运表现与回测结果一致，策略将被提升到下一个阶段。

1.  **纸上交易**：此时，策略在实时的实际数据流上运行。这样，表现将考虑数据解析延迟、计算延迟、执行延迟以及观察与定位之间的其他时间间隔。纸上交易将持续，直到收集到足够证据证明策略表现如预期。

1.  **毕业**：在这个阶段，策略管理一个真实的位置，无论是孤立的还是作为一个组合的一部分。表现会被精确评估，包括归因风险、收益和成本。

1.  **重新分配**：根据生产表现，毕业策略的分配会在多样化投资组合的背景下频繁且自动地重新评估。一般来说，策略的分配遵循一个凹函数。初始分配（在毕业时）较小。随着时间的推移，如果策略表现如预期，分配会增加。随着时间的推移，表现下降，分配逐渐变小。

1.  **退役**：最终，所有策略都会停止。这发生在它们的表现低于预期，并且持续时间足够长，以得出支持理论不再有实证依据的结论。

一般来说，发布策略的新变体并与旧版本并行运行是比较理想的。每个版本都将经历上述生命周期，而旧策略将获得较小的分配，以便实现多样化，同时考虑到它们较长历史记录所带来的信心程度。

**1.3.2 按策略组件结构**

许多投资经理认为，致富的秘诀是实施一个极其复杂的机器学习算法。他们在为自己设定失望。如果这像编写最先进的分类器那么简单，硅谷大多数人都会成为亿万富翁。成功的投资策略是多个因素的结果。表 1.1 总结了哪些章节将帮助你解决开发成功投资策略所涉及的每个挑战。

**表 1.1** **每章所解决挑战的概述**

| **部分** | **章节** | **金融数据** | **软件** | **硬件** | **数学** | **元策略** | **过拟合** |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 1 | 2 | X | X |  |  |  |

|

| 1 | 3 | X | X |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |

|

| 1 | 4 | X | X |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |

|

| 1 | 5 | X | X |  | X |  |
| --- | --- | --- | --- | --- | --- | --- |

|

| 2 | 6 |
| --- | --- |
| X |

|

|

|

|

| 2 | 7 |  | X |  |  | X | X |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 2 | 8 |  | X |  |  | X |

|

| 2 | 9 |  | X |  |  | X |
| --- | --- | --- | --- | --- | --- | --- |

|

| 3 | 10 |
| --- | --- |
| X |

|

| X |
| --- |

|

| 3 | 11 |  | X |  | X |  | X |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 3 | 12 |  | X |  | X |  | X |
| 3 | 13 |  | X |  | X |  | X |
| 3 | 14 |  | X |  | X |  | X |
| 3 | 15 |  | X |  | X |  | X |
| 3 | 16 |
| X |
| X | X | X |
| 4 | 17 | X | X |
| X |

|

|

| 4 | 18 | X | X |  | X |  |
| --- | --- | --- | --- | --- | --- | --- |

|

| 4 | 19 | X | X |
| --- | --- | --- | --- |

|

|

|

|

| 5 | 20 |  | X | X | X |  |
| --- | --- | --- | --- | --- | --- | --- |

|

| 5 | 21 |
| --- | --- |
| X | X | X |

|

|

| 5 | 22 |
| --- | --- |
| X | X | X |

|

|

在本书中，你会发现我多年来发表的许多期刊文章的引用。与其重复自己，我常常会引用其中的一篇，你将在其中找到该主题的详细分析。所有引用的论文都可以从我的网站免费下载，格式为预印本：[www.QuantResearch.org](http://www.QuantResearch.org)。

***1.3.2.1 数据***

+   问题：垃圾进，垃圾出。

+   解决方案：处理独特且难以操作的数据。如果你是该数据的唯一用户，无论其价值如何，都是你的。

+   如何：

    +   第二章：正确结构化你的数据。

    +   第三章：生成信息丰富的标签。

    +   第四章和第五章：正确建模非独立同分布系列。

    +   第 17 至 19 章：寻找预测特征。

***1.3.2.2 软件***

+   问题：专业任务需要定制工具。

+   解决方案：开发自己的类。使用流行库意味着更多竞争者会共同使用同一资源。

+   如何：

    +   第 2 至 22 章：在书中，对于每一章，我们都会开发自己的函数。针对你的特定问题，你也必须这样做，遵循书中的示例。

***1.3.2.3 硬件***

+   问题：机器学习涉及到数学中一些最耗费计算资源的任务。

+   解决方案：成为高性能计算（HPC）专家。如果可能，与你的国家实验室合作，建立超级计算机。

+   如何：

    +   第 20 和 22 章：学习如何从多处理架构的角度思考。每当你编码一个库时，都要以能够并行调用函数的方式来构建它。你将在书中找到大量示例。

    +   第二十一章：为量子计算机开发算法。

***1.3.2.4 数学***

+   问题：数学证明可能需要数年、数十年甚至数世纪。没有投资者会等这么久。

+   解决方案：使用实验数学。通过实验解决困难的、难以处理的问题，而不是通过证明。例如，Bailey、Borwein 和 Plouffe [1997] 在没有证明的情况下找到了一种*π*（圆周率）的水龙头算法，挑战了之前对这种数学发现不可能的看法。

+   如何：

    +   第五章：熟悉保留记忆的数据转换。

    +   第 11-15 章：有实验方法可以评估你的策略的价值，其可靠性大于历史模拟。

    +   第十六章：在样本中最优的算法在样本外可能表现不佳。没有数学证明可以保证投资成功。依赖实验方法来指导你的研究。

    +   第 17 和 18 章：应用方法检测结构性断裂，并量化金融系列所携带的信息量。

    +   第二十章：学习分布式计算的排队方法，以便可以拆分复杂任务并加速计算。

    +   第二十一章：熟悉离散方法，这些方法被量子计算机等用于解决难以处理的问题。

***1.3.2.5 元策略***

+   问题：业余人士发展个别策略，相信存在致富的神奇公式。相比之下，专业人士则开发批量生产策略的方法。赚钱的不是制造汽车，而是建立汽车工厂。

+   解决方案：像经营企业一样思考。你的目标是将研究实验室像工厂一样运营，真正的发现不是源于灵感，而是源于系统的努力工作。这是物理学家欧内斯特·劳伦斯的哲学，他是美国第一个国家实验室的创始人。

+   如何：

    +   第 7-9 章：建立一个研究过程，以识别跨资产类别相关的特征，同时处理金融特征的多重共线性。

    +   第十章：将多个预测合并为一个单一的赌注。

    +   第十六章：使用一种在样本外表现良好的稳健方法来分配资金给策略。

***1.3.2.6 过拟合***

+   问题：标准交叉验证方法在金融领域失败。由于多重检验和选择偏差，金融领域的大多数发现都是错误的。

+   解决方案：

    +   无论你做什么，总是问自己你可能以何种方式过拟合。对自己的工作保持怀疑，不断挑战自己证明你在创造价值。

    +   过拟合是不道德的。它导致无法兑现的有希望的结果。当明知故犯时，过拟合就是明确的科学欺诈。许多学者这么做并不意味着这是正确的：他们并没有冒任何人的财富风险，甚至连他们自己的都没有。

    +   这也是对你的时间、资源和机会的浪费。此外，行业只支付超出样本的收益。你只有在为投资者创造了可观的财富后才能成功*。

+   如何：

    +   第 11 至 15 章：有三种回测范式，其中历史模拟只是其中之一。每个回测总是会在某种程度上过拟合，学习如何量化过拟合的程度至关重要。

    +   第十六章：学习稳健的资产配置技术，这些技术不会因在样本内信号过拟合而牺牲样本外性能。

**1.3.3 按常见陷阱结构**

尽管机器学习有许多优点，但它并不是灵丹妙药。机器学习技术的灵活性和强大也有其阴暗面。当被误用时，机器学习算法会将统计偶然与模式混淆。这一事实，加上金融领域特有的低信噪比，几乎确保了粗心的用户会以越来越快的速度产生错误发现。本书揭示了一些机器学习专家在将其技术应用于金融数据集时所犯的最普遍错误。这些陷阱的一些列表在表 1.2 中列出，解决方案在指明的章节中解释。

**表 1.2** **金融机器学习中的常见陷阱**

| **#** | **类别** | **陷阱** | **解决方案** | **章节** |
| --- | --- | --- | --- | --- |
| 1 | 认识论 | 西西弗斯范式 | 元策略范式 | 1 |
| 2 | 认识论 | 通过回测进行研究 | 特征重要性分析 | 8 |
| 3 | 数据处理 | 按时间顺序采样 | 量钟 | 2 |
| 4 | 数据处理 | 整数微分 | 分数微分 | 5 |
| 5 | 分类 | 固定时间范围标记 | 三重障碍法 | 3 |
| 6 | 分类 | 同时学习边侧和大小 | 元标记 | 3 |
| 7 | 分类 | 非独立同分布样本加权 | 独特性加权；序列自举 | 4 |
| 8 | 评估 | 交叉验证泄漏 | 清除和禁运 | 7, 9 |
| 9 | 评估 | 向前推进（历史）回测 | 组合清除交叉验证 | 11, 12 |
| 10 | 评估 | 回测过拟合 | 在合成数据上的回测；被通胀调整的夏普比率 | 10–16 |

## 1.4 目标受众

本书介绍了专门设计用来解决金融数据集挑战的高级机器学习（ML）方法。“高级”并不意味着极其难以掌握，或解释最新版本的深度、递归或卷积神经网络。相反，本书回答了经验丰富的研究人员所认为的关键问题，这些研究人员曾将机器学习算法应用于金融问题。如果你是机器学习的新手，并且没有处理复杂算法的经验，那么这本书可能不适合你（还）。除非你在实践中面对过本章讨论的问题，否则你可能会很难理解解决这些问题的实用性。在阅读本书之前，你可能想研究几本近年来出版的优秀入门机器学习书籍。我在参考文献部分列出了其中的一些。

本书的核心读者是具有强大机器学习背景的投资专业人士。我的目标是让你能将本书中的学习变现，帮助我们现代化金融，为投资者提供实际价值。

本书也面向在金融以外领域成功实施机器学习算法的数据科学家。如果你曾在谷歌工作并应用深度神经网络进行人脸识别，但在金融数据上运行算法时似乎效果不佳，这本书将帮助你。有时你可能无法理解某些结构背后的金融逻辑（例如，元标记、三重障碍法、分数差分），但请耐心等候：一旦你管理投资组合的时间足够长，游戏规则会对你变得更加清晰，同时这些章节的含义也会显现。

## 1.5 前提条件

投资管理是研究中最具多学科特征的领域之一，这本书也反映了这一事实。理解各个部分需要对机器学习、市场微观结构、投资组合管理、数学金融、统计学、计量经济学、线性代数、凸优化、离散数学、信号处理、信息论、面向对象编程、并行处理和超级计算有实践性的知识。

Python 已成为机器学习的*事实*标准语言，我必须假设你是经验丰富的开发者。你必须熟悉 scikit-learn（sklearn）、pandas、numpy、scipy、多进程、matplotlib 和一些其他库。代码片段调用这些库的函数，使用它们的常规前缀，pandas 为 pd，numpy 为 np，matplotlib 为 mpl 等等。关于这些库的书籍非常多，你无法对每个库的具体内容知之甚详。在整本书中，我们将讨论它们实施中的一些问题，包括需要注意的未解决的错误。

## 1.6 常见问题解答

***机器学习算法在金融中如何有用？***

许多金融操作需要基于预定义规则做出决策，例如期权定价、算法执行或风险监控。这正是迄今为止自动化的大部分发生的地方，将金融市场转变为超快、超连接的信息交换网络。在执行这些任务时，机器被要求尽可能快地遵循规则。高频交易就是一个典型例子。有关该主题的详细讨论，请参见 Easley、López de Prado 和 O'Hara [2013]。

金融算法化势不可挡。在 1968 年 6 月 12 日到 1968 年 12 月 31 日之间，纽约证券交易所每周三关闭，以便后勤部门赶上文书工作。你能想象吗？我们今天生活在一个不同的世界，10 年后情况会更好。因为下一波自动化并不涉及遵循规则，而是做出判断。作为情感生物，我们受制于恐惧、希望和议程，人在做基于事实的决策时并不是特别擅长，尤其是在这些决策涉及利益冲突时。在这种情况下，投资者在机器根据从硬数据中学习到的事实做出决策时会更有利。这不仅适用于投资策略开发，还适用于几乎每个金融建议领域：授予贷款、评级债券、分类公司、招聘人才、预测收益、预测通货膨胀等。此外，机器在被编程遵循法律时，将始终遵守。如果做出可疑决策，投资者可以回溯记录，准确理解发生了什么。改进算法投资过程比完全依赖人类的过程要容易得多。

***机器学习算法如何在投资上战胜人类？***

你还记得人们曾坚信计算机永远无法战胜人类下棋吗？或者*危险边缘*？扑克？围棋？数百万年的进化（基因算法）让我们的猿脑在一个敌对的三维世界中生存下来，那里自然法则是静态的。现在，当涉及到在高维世界中识别微妙模式时，游戏规则每天都在变化，所有的微调反而成为了弊端。机器学习算法可以在 100 维的世界中像在我们熟悉的三维世界中一样轻松发现模式。虽然我们看到算法犯傻时总是发笑，但请记住，算法的历史仅占我们数百万年的一小部分。它们每天都在变得更好，而我们则没有。人类学习缓慢，这使我们在像金融这样快速变化的世界中处于劣势。

***这是否意味着人类投资者的空间已经没有了？***

绝对没有。没有任何人比计算机下棋更出色。而且没有任何计算机比一个由计算机支持的人更擅长下棋。当与机器学习算法对赌时，自主投资经理处于劣势，但最佳结果可能是通过将自主投资经理与机器学习算法结合来实现的。这就是所谓的“量化与基本面结合”的方式。在整本书中，你会发现可以被量化与基本面团队使用的技术，也就是允许你将人类猜测（受到基本变量启发）与数学预测相结合的方法。特别是，第三章介绍了一种称为元标记的新技术，它允许你在自主层之上添加机器学习层。

***金融机器学习与计量经济学有何不同？***

计量经济学是将经典统计方法应用于经济和金融系列的学科。计量经济学的基本工具是多元线性回归，这是一项 18 世纪的技术，早在 1794 年之前就已被高斯掌握（Stigler [1981]）。标准的计量经济模型并不具备学习能力。很难相信像 21 世纪的金融这样复杂的事物能通过简单的反转协方差矩阵来理解。

每一门实证科学都必须基于观察构建理论。如果用于建模这些观察的统计工具箱是线性回归，研究者将无法识别数据的复杂性，理论将显得极为简单、无用。我毫不怀疑，计量经济学是经济学和金融在过去 70 年未能取得实质性进展的主要原因（Calkin 和 López de Prado [2014a, 2014b]）。

数世纪以来，中世纪的天文学家们进行了观察并发展了关于天体力学的理论。这些理论从未考虑过非圆轨道，因为这被视为不洁和不符合上帝的计划。预测误差如此严重，以至于必须制定越来越复杂的理论来解释它们。直到开普勒敢于考虑非圆（椭圆）轨道时，突然出现了一种更简单的通用模型，能够以惊人的准确性预测行星的位置。如果天文学家从未考虑过非圆轨道，那会怎么样？那么……如果经济学家最终开始考虑非线性函数呢？我们的开普勒在哪里？金融没有《原理》，因为没有开普勒就没有牛顿。

金融机器学习方法并不取代理论，而是指导理论。机器学习算法在高维空间中学习模式，而不需要特定的指引。一旦我们理解了哪些特征能够预测某个现象，就可以建立一个理论解释，并在独立数据集上进行测试。经济学和金融的学生最好参加机器学习课程，而不是计量经济学。计量经济学可能足以让你在金融学术界取得成功（目前），但在商业上成功则需要机器学习。

***你对那些将机器学习算法视为黑箱的人有什么看法？***

如果你正在阅读这本书，机器学习算法对你来说很可能是一个黑箱。它们是透明的、明确定义的、清晰的模式识别函数。大多数人没有你的知识，对于他们来说，机器学习就像魔法师的箱子：“那只兔子从哪里来的？你是怎么欺骗我们的，女巫？”人们对他们不理解的事物充满怀疑。他们的偏见根植于无知，而苏格拉底的解药很简单：教育。此外，我们当中有些人喜欢动脑筋，尽管神经科学家至今仍未完全弄清大脑是如何运作的（本身就是一个黑箱）。

不时你会遇到一些无法救赎的技术抵制者。内德·卢德是来自英格兰莱斯特的一位织布工，他在 1779 年因愤怒而砸毁了两台针织机。随着工业革命的到来，因机械化而愤怒的暴民破坏并摧毁了他们能找到的所有机器。纺织工人损坏了如此多的工业设备，以至于国会不得不通过法律，将“破坏机器”定为死罪。在 1811 年至 1816 年间，英格兰的大部分地区都处于公开反抗的状态，以至于参与对抗卢德派的英国军队数量超过了在伊比利亚半岛对抗拿破仑的军队。卢德派叛乱以残酷的军事镇压而告终。让我们希望黑箱运动不会走到那一步。

***你为什么不讨论具体的机器学习算法？***

这本书对你选择的具体机器学习算法持中立态度。无论你使用卷积神经网络、AdaBoost、随机森林、支持向量机等，你将面临许多共同的通用问题：数据结构化、标记、加权、平稳变换、交叉验证、特征选择、特征重要性、过拟合、回测等。在金融建模的背景下，回答这些问题并非易事，需要开发特定框架的方法。这正是本书的重点。

***你还推荐哪些关于这个主题的书籍？***

据我所知，这是第一本全面且系统地探讨针对金融的机器学习（ML）方法的书籍：从专门讨论金融数据结构的章节开始，还有用于金融序列标记的章节、样本加权、时间序列差分……一直到专门用于投资策略适当回测的完整部分。确实，之前有少量出版物（主要是期刊文章）将标准机器学习应用于金融序列，但这并不是本书所提供的内容。我的目标是解决那些使金融机器学习建模特别具有挑战性的独特问题。像任何新主题一样，它正在快速发展，书籍会随着重大进展而更新。如果您希望在未来版本中看到任何特定主题，请联系我，邮箱是 mldp@quantresearch.org。我会乐意添加这些章节，同时承认提出建议的读者的名字。

***我不理解一些章节和内容。我该怎么办？***

我的建议是先阅读章节末尾列出的参考文献。当我写这本书时，我必须假设读者熟悉现有文献，否则这本书将失去焦点。如果在阅读那些参考文献后章节仍然无法理解，可能的原因是它们与投资专业人士非常了解的问题相关（即使文献中没有提及）。例如，第二章将讨论有效的期货价格调整方法，这是一个大多数从业者都知道的问题，即使在教科书中很少涉及。我鼓励你参加我定期举办的研讨会，并在我演讲结束时向我提问。

***为什么这本书如此专注于回测过拟合？***

这有两个原因。首先，回测过拟合可以说是数学金融中最重要的未解问题。它相当于计算机科学中的“P 与 NP”。如果有一种精确的方法可以防止回测过拟合，我们就能够将回测变现。一个回测几乎可以与现金相媲美，而不是销售推销。对冲基金将有信心将资金分配给投资组合经理。投资者的风险将降低，并愿意支付更高的费用。监管机构将根据可靠的技能和知识证据向对冲基金经理颁发许可证，给骗子留不下空间。在我看来，一本没有解决这一问题的投资书籍是浪费时间。你为什么要读一本讨论 CAPM、APT、资产配置技术、风险管理等内容的书，而这些论点的实证结果在未确定其虚假发现概率的情况下被选择？

第二个原因是，机器学习是您研究工具箱中的一个强大武器，且确实是一个危险的武器。如果在计量经济分析中存在回测过拟合的问题，机器学习的灵活性使其对您的工作构成持续威胁。尤其在金融领域，因为我们的数据集较短，信噪比低，而且我们没有可以控制所有环境变量进行实验的实验室（López de Prado [2015]）。一本不解决这些问题的机器学习书籍对您的职业生涯可能弊大于利。

***这本书的数学术语是什么？***

当我开始写这本书时，我考虑为每个数学变量或函数在所有章节中分配一个符号。如果这本书只涉及一个主题，例如随机最优控制，那会很好。然而，这本书涉及广泛的数学主题，每个主题都有其自己的惯例。读者会发现，如果我不遵循文献标准，查阅参考资料会变得更加困难，这意味着有时我们必须重复使用符号。为了防止任何混淆，每一章都会解释所使用的术语。大多数数学内容都伴随有代码片段，因此如有疑问，请始终遵循代码。

***谁写了第二十二章？***

一个普遍的看法是，机器学习是一项在 IBM、谷歌、脸书、亚马逊、Netflix、特斯拉等公司发明或完善的新技术。确实，技术公司近年来已经成为机器学习的重度用户。这些公司赞助了一些最近备受关注的机器学习成就（如*危险边缘*或围棋），这可能增强了这种看法。

然而，读者可能会惊讶地发现，实际上，美国国家实验室是使用机器学习的研究中心中历史悠久且经验丰富的机构。这些中心在机器学习变得流行之前就已经在使用它，并成功应用了几十年，产生了惊人的科学发现。如果预测 Netflix 应该推荐给你观看的电影是一个值得的努力，那么理解宇宙的扩张速率、预测全球变暖将对哪些海岸线产生最大影响，或者防止国家电网发生灾难性故障同样值得。这些只是伯克利实验室等机构每天默默而不懈地利用机器学习研究的一些令人惊叹的问题。

在第二十二章中，霍斯特·西蒙博士和吴克生博士提供了在一家专注于大规模科学研究的美国国家实验室中，作为副主任和项目负责人的视角，该实验室涉及大数据、高性能计算和机器学习。与传统大学环境不同，国家实验室通过组建跨学科团队，遵循精心设计的程序，实现科学突破，具有明确的分工和责任。这种通过生产链进行研究的模型几乎是在 90 年前在伯克利实验室诞生，并启发了第 1.2.2 节和第 1.3.1 节中解释的元策略范式。

## 1.7 致谢

霍斯特·西蒙博士是劳伦斯伯克利国家实验室的副主任，他与负责多个项目的吴克生博士共同撰写了第二十二章。机器学习需要极大的计算能力，没有他们的慷慨支持和指导，我的研究是无法进行的。在那一章中，霍斯特和克生解释了劳伦斯伯克利实验室如何满足全球研究人员的超级计算需求，以及机器学习和大数据在当今科学突破中所扮演的关键角色。

里卡多·雷博纳托教授是第一个阅读这份手稿并鼓励我出版的人。我与弗兰克·法博兹教授在这些主题上的多次对话对书籍的形成起到了重要作用。在学术界，很少有人具备弗兰克和里卡多的行业经验，而在行业中，也很少有人拥有里卡多和弗兰克的学术背景。

在过去的二十年里，我在本书主题上发表了近百篇作品，包括期刊文章、书籍、章节、讲座、源代码等。根据我最新的统计，这些作品与超过 30 位该领域的顶尖专家共同署名，包括大卫·H·贝利教授（15 篇文章）、大卫·伊斯利教授（8 篇文章）、莫琳·奥哈拉教授（8 篇文章）和乔纳森·M·博尔维因教授（6 篇文章）。在很大程度上，这本书也属于他们，因为没有他们多年来的支持、见解和持续的思想交流，这本书是无法完成的。给予他们适当的信用将花费太长时间，因此我发布了以下链接，您可以在其中找到我们的集体努力：[`www.quantresearch.org/Co-authors.htm`](http://www.quantresearch.org/Co-authors.htm)。

最后但同样重要的是，我要感谢我的一些研究团队成员对书籍的校对，并帮助我制作了一些图表：迭戈·阿帕里西奥、李·科恩博士、迈克尔·刘易斯博士、迈克尔·洛克博士、曾亚雄博士和张志白博士。

**练习**

1.  > > 你知道哪些公司尝试从自由裁量投资转向机器学习主导的投资，或者将其融合成他们所称的“量化基本面”基金吗？

    1.  他们成功了吗？

    1.  在这一转型中涉及哪些文化难题？

1.  > > 数学金融中最重要的未解决问题是什么？如果这个问题得以解决，如何能够：

    1.  监管机构用它来授予投资管理许可证吗？

    1.  投资者用它来分配资金吗？

    1.  公司用它来奖励研究人员吗？

1.  > > 根据 *机构投资者*，只有 17% 的对冲基金资产由定量公司管理。截至 2017 年 6 月，所有定量基金总共分配约 5000 亿美元，而一年前为 3860 亿美元。你认为是什么驱动了这种大规模的资产重新配置？
1.  > > 
1.  > > 根据 *机构投资者* 的富豪榜，有多少定量投资公司位列前 10 名最盈利公司？这与定量基金管理的资产比例相比如何？
1.  > > 
1.  > > 计量经济学方法与机器学习之间的关键区别是什么？经济学和金融学如何从更新其统计工具包中受益？
1.  > > 
1.  > > 科学对人脑（或任何脑）如何工作几乎没有了解。在这个意义上，大脑是一个绝对的黑箱。你认为是什么导致金融机器学习的批评者将其视为黑箱，而接受自由裁量投资？
1.  > > 
1.  > > 你阅读了一篇描述投资策略的期刊文章。在回测中，它的年化夏普比率超过 2，置信水平为 95%。利用他们的数据集，你能够在独立回测中重现他们的结果。为什么这一发现可能是错误的？
1.  > > 
1.  > > 投资顾问在代表投资者做决策时面临利益冲突。

    1.  机器学习算法可以在没有利益冲突的情况下管理投资。为什么？

    1.  假设一个机器学习算法做出的决策导致了损失。该算法执行了其被编程的操作，投资者同意了程序条款，经过计算机日志的法医检查得以验证。与因自由裁量基金经理的糟糕判断而导致的损失相比，这种情况在什么意义上对投资者更好？投资者在每种情况下的救济措施是什么？

    1.  对于金融顾问来说，将他们的决策与这些中立代理人的决策进行基准比较是否有意义？

**参考文献**

1.  贝利, D.，P. 博尔温 和 S. 普卢夫 (1997)： “各种多对数常数的快速计算。” *计算数学*，第 66 卷，第 218 期，第 903–913 页。

1.  卡尔金, N. 和 M. 洛佩斯·德·普拉多 (2014a)： “随机流图。” *算法金融*，第 3 卷，第 1 期，第 21–42 页。

1.  卡尔金, N. 和 M. 洛佩斯·德·普拉多 (2014b)： “宏观金融流的拓扑：随机流图的应用。” *算法金融*，第 3 卷，第 1 期，第 43–85 页。

1.  易斯利, D.，M. 洛佩斯·德·普拉多 和 M. 奥哈拉 (2013)： *高频交易*，第 1 版。风险出版社。

1.  洛佩斯·德·普拉多, M. (2014)： “定量元策略。” *实用应用，机构投资者期刊*，第 2 卷，第 3 期，第 1–3 页。

1.  López de Prado, M. (2015)： “经验金融的未来。” *投资组合管理杂志*，第 41 卷，第 4 期，页 140–144。

1.  Stigler, Stephen M. (1981)： “高斯与最小二乘法的发明。” *统计年鉴*，第 9 卷，第 3 期，页 465–474。

**参考书目**

1.  Abu-Mostafa, Y., M. Magdon-Ismail, 和 H. Lin (2012)： *从数据中学习*，第 1 版。AMLBook。

1.  Akansu, A., S. Kulkarni, 和 D. Malioutov (2016)： *金融信号处理与机器学习*，第 1 版。John Wiley & Sons-IEEE 出版社。

1.  Aronson, D. 和 T. Masters (2013)： *金融工具算法交易的统计学机器学习：基于预测模型的交易系统开发*，第 1 版。CreateSpace 独立出版平台。

1.  Boyarshinov, V. (2012)： *计算金融中的机器学习：构建人工智能应用的实用算法*，第 1 版。LAP LAMBERT 学术出版。

1.  Cerniglia, J., F. Fabozzi, 和 P. Kolm (2016)： “定量股票策略研究的最佳实践。” *投资组合管理杂志*，第 42 卷，第 5 期，页 135–143。

1.  Chan, E. (2017)： *机器交易：部署计算机算法征服市场*，第 1 版。John Wiley & Sons。

1.  Gareth, J., D. Witten, T. Hastie, 和 R. Tibshirani (2013)： *统计学习导论：R 语言的应用*，第 1 版。Springer。

1.  Geron, A. (2017)： *使用 Scikit-Learn 和 TensorFlow 的动手机器学习：构建智能系统的概念、工具和技术*，第 1 版。O'Reilly Media。

1.  Gyorfi, L., G. Ottucsak, 和 H. Walk (2012)： *金融工程的机器学习*，第 1 版。帝国学院出版社。

1.  Hackeling, G. (2014)： *精通 Scikit-Learn 的机器学习*，第 1 版。Packt Publishing。

1.  Hastie, T., R. Tibshirani, 和 J. Friedman (2016)： *统计学习的要素*，第 2 版。Springer-Verlag。

1.  Hauck, T. (2014)： *Scikit-Learn 食谱*，第 1 版。Packt Publishing。

1.  McNelis, P. (2005)： *金融中的神经网络*，第 1 版。学术出版社。

1.  Raschka, S. (2015)： *Python 机器学习*，第 1 版。Packt Publishing。

**备注**

^(1)    伯克利实验室，[`www.lbl.gov/about`](http://www.lbl.gov/about) 。

^(2)     [`www.numbersleuth.org/worlds-gold/`](http://www.numbersleuth.org/worlds-gold/) 。

^(3)     [`www.nersc.gov/about`](http://www.nersc.gov/about) 。

