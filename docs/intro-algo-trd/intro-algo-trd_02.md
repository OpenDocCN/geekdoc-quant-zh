# 第二章 - 算法交易基础

“我相信规则是为了被打破的。”——电影制片人罗伯特·埃文斯（可能并不是成功的交易者）

每次交易，无论你是初学者、中级还是专家，你都在使用规则来交易。你可能没有意识到这些规则，规则可能会每天或每小时变化，但确实存在规则。规则是你的决策过程——你如何决定是否进入或退出特定交易。它可能是混乱和支离破碎的，但那里一定有一个规则。也许你的规则是“规则是用来打破的！”

所以，当 CNBC 上那个古怪的评论员大喊“买这只股票！”你会跟随他的建议吗？

规则：某人说买，你就买。

你表哥给你打电话告诉你内幕消息？

规则：疯狂的表哥说他有“内部”信息，你只在他上次的建议获利时才买入。

使用技术指标吗？

规则：如果价格高于 20 期平均值，并且 RSI 值低于 20，则做空。

列表是无止境的——买卖规则是无限的。但当它们被写下来、严格遵循且不受判断或自由裁量的影响时，这些规则就可以转化为算法。

## “算法”中包含什么？

让我们来看看典型交易算法的组成部分。我还将用简单的英语和 Tradestation Easy Language 给出一些例子。

多头进场

这是绝对必要的——你打算如何在多头（买入）方面进入市场？你必须有标准，或一组标准，来进入市场。

一个例子可能是一个简单的动量类型进场：

伪代码：如果当前收盘价大于 5 根 K 线前的收盘价，则在下一根 K 线开盘时做多。

Tradestation Easy Language 代码：如果 close>close[5]，则在下一根 K 线以市场价买入；

短头进场

如果你在交易股票，你可能不想在市场上做空（[`www.investopedia.com/terms/s/shortselling.asp`](https://www.investopedia.com/terms/s/shortselling.asp)）。但对于期货和外汇，你几乎肯定希望能够做空，以从价格下跌中获利。在这种情况下，你需要一个做空进场规则。

现在，这个规则可能与多头进场规则正好相反，或者可能完全不同。这就是创建自己算法的有趣之处——你可以按自己想要的方式设置。定制算法以符合个人偏好的能力还有一个隐藏的好处——我发现比起遵循别人设定的规则，遵循我自己创建的策略规则要容易得多。请记住，良好的算法交易就是遵循规则。

一个短线进场的例子可能是简单的移动平均线交叉：

伪代码：如果收盘价跌破 7 期移动平均线，则在下一根 K 线做空。

Tradestation Easy Language 代码：如果收盘价跌破平均值（close,7），则在下一根 K 线以市场价做空；

多头出场

显然，如果你有一个多头进场规则，你也需要一个多头退出规则。这个退出可以基于当前头寸的利润或损失（见下一几页的“止损”和“利润目标”），也可以基于技术指标、图表模式等。它只是一个触发器，用来告诉你退出多头头寸。

多头退出的一个例子可以是图表模式——在连续两个下跌收盘后退出：

伪代码：如果此柱的收盘价低于前一柱的收盘价，并且前一柱的收盘价低于两根柱前的收盘价，则退出多头头寸。

Tradestation 易语言代码：如果 close<close[1] 且 close[1]<close[2]，则在下一个柱以市价卖出；

空头退出

如果你有一个空头进场，你可能也会想要一个空头退出。

空头退出的一个例子可以是在每个星期四平仓：

伪代码：如果今天是星期四，则退出空头。

Tradestation 易语言代码：如果 dayofweek(Date)=4，则在下一个柱以市价买回；

停止并反转

对于上述多头和空头退出，当前头寸将被平仓，使交易者保持平仓状态。但是如果你想反转头寸呢？假设你是多头，如果满足某些条件，你希望同时退出多头并做空？

一个例子是如果出现新低，则反向做多并做空：

伪代码：如果当前柱的低点是过去 12 根柱的最低低点，则退出多头并做空。

Tradestation 易语言代码：如果 low=lowest(low,12)，则在下一个柱以市价卖空；

止损

大多数算法交易者希望保护自己，以防价格逆转。考虑到某个时刻退出市场是合理的，无论技术指标、图表模式或任何使用的进场信号显示什么。这可以通过简单的止损实现。

伪代码：如果当前头寸的损失达到-$500，则退出头寸。

Tradestation 易语言代码：SetStopLoss(500);

利润目标

与止损一样，大多数算法交易者希望在价格朝有利方向移动时退出。当达到某个利润水平时，他们希望退出。

伪代码：如果当前头寸的利润达到+$2500，则退出头寸。

Tradestation 易语言代码：SetProfitTarget(2500);

头寸规模

作为一个可选功能，你可能希望算法决定买入/卖出多少股或合约。这包括头寸规模的概念，这是一个独立的话题！一些常见的头寸规模技术包括固定分数和固定比率，以及简单的“每$y 的股本交易 x 合约”。

伪代码：每$10,000 的当前股本交易 1 个合约（起始股本加上到目前为止的利润）

Tradestation 易语言代码：ncons = int((startingequity+NetProfit)/10000); 在下一个柱以市价买入 ncons 合约；

订单类型

你的算法可以下的订单类型部分取决于交易平台。最常见的三种类型是市价单、止损单和限价单。

Tradestation 易语言代码：

//市场订单

在市场上以市价买入下一根柱子；

//止损单

在 XXXX 停止时在下一根柱子卖出； //其中 XXXX=您希望在当前市场价格以下退出的价格

//限价单

在 XXXX 限价时在下一根柱子卖出； //其中 XXXX=您希望在当前市场价格以上退出的价格

大订单成交算法

我刚提到的所有算法组件都可以被零售交易者使用。大型专业交易者有自己的算法，您可能听说过。这些包括各种类型的“成交”算法——用于大规模交易某种工具的方案。当您交易类似迷你 S&P 期货的 1000 合约时，您不能仅仅提交一个 1000 合约的市场订单——这会扰乱市场，并给您一个糟糕的平均成交价格。该订单需要“处理”，也就是说，需要分解成小块，在特定时间或特定价格附近完成成交。

您可能永远不需要这些类型的算法，但您应该知道它们的存在。

更高级的算法

在刚才给出的示例组件中，假设交易者只交易一个算法。但当交易者有 10 个、20 个或更多算法时，会发生什么呢？那时候事情是如何运作的？

答案是，一旦编码了一个单一算法，这些算法可以独立存在，或者它们可以“相互交流”。也许您会想限制不同算法产生的未平仓头寸数量，或者可能基于所有算法的当前利润来决定头寸大小。可能性令人瞠目结舌，超出了本书的范围。但理解这些“附加功能”对于一个简单的市场算法是存在的，还是很有价值的。

对于许多交易者来说，为了简单起见，他们将每个算法视为独立的小世界。然后，他们使用外部分析（可能在 Excel 中）将算法组合成一个投资组合，以确定适当的风险敞口、适当的头寸大小等。这是初学者算法交易者尚不需要担心的事情，但至少应该知道。

综合应用

这里有一个简单的算法示例，它既能做多又能做空，具有止损和利润目标，可以停止和反转，并且也可以平仓。它还包含一种简单的头寸大小方法。我不推荐它（因为您个人尚未测试并验证该算法是盈利的），但您可以将其放入您的交易平台并开始交易。

Tradestation 易语言代码：

输入：初始资本（10000）；

变量：Ncons(1)；

//头寸大小计算

Ncons=四舍五入(((初始资本+净利润)/10000),0);

//多头和空头入场，将停止并反转

如果 close>close[5] 则在下一根柱子以市价买入 Ncons 合约；

如果 close<close[5] 则在下一根柱子以市价卖空 Ncons 合约；

//多头和空头的技术性退出

如果 close=最低(close,3) 则在下一根柱子以市价卖出；

如果 close=最高(close,3) 则在下一根柱子以市价买回；

//标准美元止损和利润目标

设置止损合约；

设置止损(500)；

SetProfitTarget(2000);
