**9.4 评分与超参数调优**

片段 9.1 和 9.3 为元标签应用设置了 `scoring=‘f1’`。对于其他应用，它们设置了 `scoring=`neg_log_loss`` 而不是标准的 `scoring=‘accuracy’`。尽管准确度有更直观的解释，我建议你在调整投资策略的超参数时使用 `neg_log_loss`。让我解释一下我的理由。

假设你的机器学习投资策略预测你应该以高概率购买某个证券。你将根据策略的信心进入一个较大的多头头寸。如果预测是错误的，而市场反而下跌，你将会损失很多钱。然而，准确度对高概率的错误买入预测和低概率的错误买入预测一视同仁。此外，准确度可以用低概率的命中来弥补高概率的漏掉。

投资策略通过以高信心预测正确标签而获利。低信心的良好预测所带来的收益不足以弥补高信心的错误预测带来的损失。因此，准确度无法真实反映分类器的性能。相反，日志损失 ^(3)（也称交叉熵损失）计算分类器在给定真实标签时的对数似然，考虑了预测的概率。日志损失可以如下估计：

![](img/Image00409.jpg)

其中

+   *p [*n* , *k*]* 是与标签 *k* 的预测 *n* 相关的概率。

+   *Y* 是一个 1-of-*K* 的二元指示矩阵，当观察 *n* 被分配标签 *k*（从 *K* 个可能标签中）时，*y [*n* , *k*]* = 1，否则为 0。

假设分类器预测两个 1，其中真实标签分别为 1 和 0。第一个预测是命中，第二个预测是漏掉，因此准确度为 50%。图 9.2 绘制了这些预测来自于概率范围 [0.5, 0.9] 时的交叉熵损失。可以观察到在图的右侧，由于高概率的漏掉，日志损失很大，尽管所有情况下的准确度都是 50%。

![](img/Image00411.jpg)

**图 9.2** 日志损失与命中和漏掉的预测概率的关系

偏好交叉熵损失而不是准确度的第二个原因是，交叉验证通过应用样本权重来评估分类器（见第七章，第 7.5 节）。正如您在第四章中回忆的那样，观察权重是根据观察的绝对收益确定的。这意味着，样本加权的交叉熵损失在 PNL（市值损益）计算中估计了分类器的表现：它使用正确的标签来表示方向，概率来表示头寸规模，样本权重来表示观察的收益/结果。这是金融应用中超参数调整的正确机器学习性能指标，而不是准确度。

当我们使用对数损失作为评分统计时，通常更喜欢改变其符号，因此称之为“负对数损失 *.* ”。这种变化的原因是出于美观，基于直觉：高的负对数损失值优于低的负对数损失值，这与准确度类似。在使用`neg_log_loss`时，请记住这个 sklearn 的 bug：[`github.com/scikit-learn/scikit-learn/issues/9144`](https://github.com/scikit-learn/scikit-learn/issues/9144)。为了规避此 bug，您应该使用第七章中介绍的`cvScore`函数。

**练习**

1.  > > 使用第八章中的`getTestData`函数，形成一个包含 10,000 个观测值和 10 个特征的合成数据集，其中 5 个是信息性特征，5 个是噪声特征。

    1.  在 10 折交叉验证中使用`GridSearchCV`来寻找具有 RBF 内核的 SVC 的`C`和`gamma`最优超参数，其中`param_grid = {'C':[1E-2,1E-1,1,10,100],'gamma':[1E-2,1E-1,1,10,100]}`，评分函数为`neg_log_loss`。

    1.  网格中有多少个节点？

    1.  找到最优解决方案花了多少次拟合？

    1.  找到这个解决方案花了多长时间？

    1.  如何访问最优结果？

    1.  最优参数组合的 CV 评分是多少？

    1.  如何将样本权重传递给 SVC？

1.  > > 使用练习 1 中的相同数据集，

    1.  在 10 折交叉验证中使用`RandomizedSearchCV`来寻找具有 RBF 内核的 SVC 的`C`和`gamma`最优超参数，其中`param_distributions = {`C`:logUniform(a = 1E-2,b = 1E2),`gamma`:logUniform(a = 1E-2,b = 1E2)},n_iter = 25`，评分函数为`neg_log_loss`。

    1.  找到这个解决方案花了多长时间？

    1.  最优参数组合是否与练习 1 中找到的类似？

    1.  最优参数组合的 CV 评分是多少？与练习 1 中的 CV 评分相比如何？

1.  > > 来自练习 1，

    1.  计算从 1.a 中得出的样本内预测的夏普比率（有关夏普比率的定义，请参见第十四章）。

    1.  重复 1.a，这次使用`accuracy`作为评分函数。计算由超参数调整得出的样本内预测。

    1.  哪种评分方法导致更高的（样本内）夏普比率？

1.  > > 来自练习 2，

    1.  计算从 2.a 中得出的样本内预测的夏普比率。

    1.  重复第 2.a 点，这次用 `accuracy` 作为评分函数。计算基于超调参数的样本内预测。

    1.  什么评分方法会导致更高的（样本内）Sharpe 比率？

1.  > > 阅读日志损失的定义，*L* [*Y* , *P*]。

    1.  为什么评分函数 `neg_log_loss` 被定义为负日志损失，− *L* [*Y* , *P*]？

    1.  最大化日志损失而不是负日志损失的结果会是什么？

1.  > > 考虑一种投资策略，无论预测的置信度如何，均等地调整赌注。在这种情况下，进行超参数调整时，更合适的评分函数是准确性还是交叉熵损失？

**参考文献**

1.  Bergstra, J., R. Bardenet, Y. Bengio 和 B. Kegl (2011): “超参数优化的算法。” *神经信息处理系统进展*，页 2546–2554。

1.  Bergstra, J. 和 Y. Bengio (2012): “超参数优化的随机搜索。” *机器学习研究期刊*，第 13 卷，页 281–305。

**参考书目**

1.  Chapelle, O., V. Vapnik, O. Bousquet 和 S. Mukherjee (2002): “为支持向量机选择多个参数。” *机器学习*，第 46 卷，页 131–159。

1.  Chuong, B., C. Foo 和 A. Ng (2008): “对数线性模型的高效多超参数学习。” *神经信息处理系统进展*，第 20 卷。可在 [`ai.stanford.edu/∼chuongdo/papers/learn_reg.pdf`](http://ai.stanford.edu/~chuongdo/papers/learn_reg.pdf) 查阅。

1.  Gorissen, D., K. Crombecq, I. Couckuyt, P. Demeester 和 T. Dhaene (2010): “用于计算机设计的替代建模和自适应采样工具箱。” *机器学习研究期刊*，第 11 卷，页 2051–2055。

1.  Hsu, C., C. Chang 和 C. Lin (2010): “支持向量分类的实用指南。” 技术报告，国立台湾大学。

1.  Hutter, F., H. Hoos 和 K. Leyton-Brown (2011): “通用算法配置的顺序模型优化。” 第五届国际学习与智能优化会议论文集，页 507–523。

1.  Larsen, J., L. Hansen, C. Svarer 和 M. Ohlsson (1996): “神经网络的设计与正则化：验证集的最佳使用。” 1996 年 IEEE 信号处理学会研讨会论文集。

1.  Maclaurin, D., D. Duvenaud 和 R. Adams (2015): “通过可逆学习进行基于梯度的超参数优化。” 工作论文。可在 [`arxiv.org/abs/1502.03492`](https://arxiv.org/abs/1502.03492) 查阅。

1.  Martinez-Cantin, R. (2014): “BayesOpt：用于非线性优化、实验设计和赌博的贝叶斯优化库。” *机器学习研究期刊*，第 15 卷，页 3915–3919。

**注释**

^(1)     [`scikit-learn.org/stable/modules/metrics.html.`](http://scikit-learn.org/stable/modules/metrics.html.)

^(2)     [`scikit-learn.org/stable/auto_examples/svm/plot_rbf_parameters.html.`](http://scikit-learn.org/stable/auto_examples/svm/plot_rbf_parameters.html.)

^(3)     [`scikit-learn.org/stable/modules/model_evaluation.html#log-loss`](http://scikit-learn.org/stable/modules/model_evaluation.html#log-loss) .

**第三部分**

**回测**

1.  第十章 下注大小

1.  第十一章 回测的危险

1.  第十二章 通过交叉验证进行回测

1.  第十三章 在合成数据上回测

1.  第十四章 回测统计

1.  第十五章 理解策略风险

1.  第十六章 机器学习资产配置

**第十章**

**下注大小**

**10.1 动机**

策略游戏和投资之间有着迷人的相似之处。我曾与一些最优秀的投资组合经理合作，他们都是出色的扑克玩家，也许比棋手更优秀。一个原因是下注大小，德州扑克牌提供了很好的类比和训练场。你的机器学习算法可以实现高准确度，但如果你不正确地设置下注大小，你的投资策略必然会亏损。在本章中，我们将回顾几种基于机器学习预测的下注大小方法。

**10.2 独立于策略的下注大小方法**

考虑在同一工具上的两种策略。令 *m [*i* , *t*]* ∈ [ − 1, 1] 为策略 *i* 在时间 *t* 的下注大小，其中 *m [*i* , *t*]* = −1 表示完全空头头寸，而 *m [*i* , *t*]* = 1 表示完全多头头寸。假设一种策略产生了一系列下注大小 [ *m [1, 1]* , *m [1, 2]* , *m [1, 3]* ] = [.5, 1, 0]，市场价格跟随的序列为 [ *p [1]* , *p [2]* , *p [3]* ] = [1, .5, 1.25]，其中 *p [*t*]* 是时间 *t* 的价格。另一种策略产生的序列为 [ *m [2, 1]* , *m [2, 2]* , *m [2, 3]* ] = [1, .5, 0]，因为它在市场对初始全头寸不利时被迫减少下注大小。两种策略的预测都正确（在 *p [1]* 和 *p [3]* 之间价格上涨了 25%），然而第一种策略盈利 (0.5)，而第二种策略亏损 (−.125)。

我们希望以某种方式调整头寸，以便为交易信号在减弱之前可能增强的情况保留一些现金。一种选择是计算序列 *c [*t*]* = *c [*t* , *l*]* − *c [*t* , *s*]*，其中 *c [*t* , *l*]* 是时间 *t* 时同时存在的多头赌注数量，而 *c [*t* , *s*]* 是时间 *t* 时同时存在的空头赌注数量。这种赌注并发性是类似于我们在第四章中计算标签并发性的方法得出的（回忆一下 `t1` 对象，具有重叠的时间跨度）。我们对 { *c [*t*]* } 进行两个高斯混合模型的拟合，采用类似于 López de Prado 和 Foreman [2014] 中描述的方法。然后，赌注大小得出为

![](img/Image00413.jpg)

其中 *F* [ *x* ] 是拟合的两个高斯混合模型在值 *x* 处的累积分布函数（CDF）。例如，当观察到更大值的信号的概率仅为 0.1 时，我们可以将赌注大小设为 0.9。信号越强，信号变得更强的概率越小，因此赌注大小越大。

第二种解决方案是采用预算方法。我们计算同时存在的多头赌注的最大数量（或其他某个分位数），![](img/Image00417.jpg)，以及同时存在的空头赌注的最大数量，![](img/Image00420.jpg)。然后我们得出赌注大小为 ![](img/Image00422.jpg)，其中 *c [*t*  ,  *l*]* 是时间 *t* 时同时存在的多头赌注数量，而 *c [*t*  ,  *s*]* 是时间 *t* 时同时存在的空头赌注数量。目标是在最后一个并发信号触发之前，不达到最大头寸。

第三种方法是应用元标签技术，如我们在第三章中解释的那样。我们拟合一个分类器，例如 SVC 或 RF，以确定误分类的概率，并利用该概率推导赌注大小。^(1) 这种方法有几个优点：首先，决定赌注大小的机器学习算法独立于主要模型，允许引入预测假阳性的特征（见第三章）。其次，预测概率可以直接转化为赌注大小。让我们看看如何实现。

**10.3 根据预测概率进行赌注大小调整**

我们用 *p* [ *x* ] 表示标签 *x* 发生的概率。对于两个可能的结果，*x* ∈ { − 1, 1}，我们希望检验原假设 ![](img/Image00424.jpg)。我们计算检验统计量 ![](img/Image00426.jpg)，其中 *z* ∈ ( − ∞, +∞)，*Z* 表示标准正态分布。我们得出赌注大小为 *m* = 2 *Z* [ *z* ] − 1，其中 *m* ∈ [ − 1, 1]，*Z* [.] 是 *Z* 的 CDF。

对于超过两个可能结果的情况，我们遵循一对多的方法。设 *X* = { − 1, …, 0, …, 1} 为与赌注大小相关的各种标签，*x* ∈ *X* 为预测标签。换句话说，标签是由与之相关的赌注大小所确定的。对于每个标签 *i* = 1, …, || *X* ||，我们估计概率 *p [*i*]*，其中 ![](img/Image00429.jpg) *.* 我们将 ![](img/Image00431.jpg) 定义为 *x* 的概率，我们希望对 ![](img/Image00433.jpg) 进行检验。^(  2  ) 我们计算检验统计量 ![](img/Image00434.jpg)，其中 *z* ∈ 0., . + ∞)。我们将赌注大小推导为 ![，其中 *m* ∈ [ − 1, 1]，而 *Z* [ *z* ] 调节预测 *x* 的大小（其中边际由 *x* 隐含）。

图 10.1 绘制了赌注大小与检验统计量的关系。片段 10.1 实现了从概率到赌注大小的转换。它处理了预测来自元标签估计器或标准标签估计器的可能性。在步骤 #2 中，它还平均化活跃赌注，并离散化最终值，我们将在后面的章节中解释。

![](img/Image00399.jpg)

**图 10.1** 预测概率下的赌注大小

> **片段 10.1 从概率到赌注大小**
> 
> ![](img/Image00465.jpg)

**10.4 活跃赌注的平均化**

每个赌注都与持有期相关，涵盖从赌注产生到触及第一个障碍的时间 `t1`（见第三章）。一种可能的方法是在新赌注到来时覆盖旧赌注；然而，这可能导致过度交易。更明智的方法是在某一时刻平均所有仍然活跃的赌注大小。片段 10.2 说明了这个想法的一种可能实现。

> **片段 10.2 只要仍然活跃，赌注就被平均化**
> 
> ![](img/Image00544.jpg)

**10.5 大小离散化**

平均化可以减少一些过度交易，但仍然可能会在每次预测时触发小额交易。由于这种抖动可能导致不必要的过度交易，我建议将赌注大小离散化为 ![](img/Image00014.jpg)，其中 *d* ∈ (0, ..1] 决定离散化的程度。图 10.2 说明了赌注大小的离散化。片段 10.3 实现了这个概念。

![](img/Image00724.jpg)

**图 10.2** 赌注大小的离散化，d = 0.2

> **片段 10.3 大小离散化以防止过度交易**
> 
> ![](img/Image00120.jpg)

**10.6 动态赌注大小和限制价格**

回顾第三章中介绍的三重障碍标记方法。*i* 号障碍在时间 *t [*i* , 0]* 形成，此时我们预测将触及的第一个障碍。该预测隐含了与障碍设置一致的预测价格 ![](img/Image00023.jpg)。在结果发生之前的时间段内，*t* ∈ [ *t [*i* , 0] * , *t [*i* , 1] * ]，价格 *p [*t*] * 波动，可能会形成额外的预测 ![](img/Image00156.jpg)，其中 *j* ∈ [ *i* + 1, *I* ] 且 *t [*j* , 0] * ≤ *t [*i* , 1] * 。在第 10.4 节和第 10.5 节中，我们讨论了在形成新预测时对活跃赌注进行平均和离散化赌注大小的方法。在本节中，我们将介绍一种方法来调整赌注大小，因为市场价格 *p [*t*] * 和预测价格 *f [*i*] * 发生波动。在这个过程中，我们将推导出订单的限价。

令 *q [*t*]* 为当前头寸，*Q* 为最大绝对头寸大小，![](img/Image00028.jpg) 为与预测 *f [*i*] * 相关的目标头寸大小，使得

![](img/Image00193.jpg)

![](img/Image00210.jpg)

其中 *m* [ω, *x* ] 是赌注大小，*x* = *f [*i*]* − *p [*t*]* 是当前市场价格与预测之间的偏差，ω 是调节 sigmoid 函数宽度的系数，Int[ *x* ] 是 *x* 的整数值。请注意，对于实值价格偏差 *x* ，− 1 < *m* [ω, *x* ] < 1，整数值 ![](img/Image00231.jpg) 是有界的 ![](img/Image00249.jpg)。

目标头寸大小 ![](img/Image00044.jpg) 可以根据 *p [*t*] * 的变化动态调整。特别地，当 *p [*t*] * → *f [*i*] * 时，我们得到 ![](img/Image00285.jpg)，因为算法希望实现收益。这意味着为了避免实现损失，订单大小的盈亏平衡限价是 ![](img/Image00303.jpg) 。具体来说，

![](img/Image00339.jpg)

其中 *L* [ *f [*i*]* , ω, *m* ] 是关于 *p [*t*]* 的 *m* [ω, *f [*i*]* − *p [*t*]* ] 的反函数，

![](img/Image00361.jpg)

我们不需要担心 *m ²* = 1 的情况，因为 ![](img/Image00380.jpg) *.* 由于该函数是单调的，算法在 *p [*t*] * → *f [*i*] * 时无法实现损失。

让我们校准ω。给定用户定义的对 ( *x* , *m* *），使得 *x* = *f [*i*]* − *p [*t*]* 和 *m* * = *m* [ω, *x* ]，关于ω的 *m* [ω, *x* ] 的反函数是

![](img/Image00396.jpg)

代码片段 10.4 实现了一个算法，该算法根据*p [*t*]*和*f [*i*]*计算动态头寸大小和限制价格。首先，我们对 sigmoid 函数进行校准，以便在价格偏差*x* = 10 时返回一个下注大小*m* * = .95。第二，我们计算目标头寸 ![](img/Image00412.jpg)，最大头寸*Q* = 100，*f [*i*]* = 115 和*p [*t*]* = 100。如果你尝试*f [*i*]* = 110，你会得到 ![](img/Image00427.jpg)，这与ω的校准一致。第三，此大小订单的限制价格为*p [*t*]* < 112.3657 < *f [*i*]*，位于当前价格和预测价格之间。

> **代码片段 10.4 动态头寸大小和限制价格**
> 
> ![](img/Image00451.jpg)

作为 sigmoid 函数的替代方案，我们可以使用幂函数 ![](img/Image00081.jpg)，其中ω ≥ 0，*x* ∈ [−1, 1]，其结果为 ![](img/Image00104.jpg)。这种替代方案具有以下优点：

+   ![](img/Image00489.jpg)。

+   曲率可以通过ω直接操控。

+   对于ω > 1，该函数由凹变为凸，而不是反过来，因此该函数在拐点附近几乎是平坦的。

我们将幂函数方程的推导留给读者作为练习。图 10.3 绘制了下注大小（y 轴）作为价格偏差*f* − *p [*t*]*（x 轴）的函数，包括 sigmoid 和幂函数。

![](img/Image00090.jpg)

**图 10.3** *f* [*x*] = *sgn* [*x*]|*x*|²（由凹到凸）和 *f* [*x*] = *x* (.1 + *x²*) ^(−.5)（由凸到凹）

**练习**

1.  > > 使用第 10.3 节中的公式，绘制下注大小（*m*）作为最大预测概率的函数（![](img/Image00520.jpg)当|| *X* || = 2, 3, …, 10 时）。
1.  > > 
1.  > > 从均匀分布中抽取 10,000 个随机数，边界为*U* [.5, 1.]。

    1.  计算下注大小*m*，使得||*X*|| = 2*。

    1.  将 10,000 个连续的日历天分配给下注大小。

    1.  从均匀分布中抽取 10,000 个随机数，边界为*U* [1, 25]。

    1.  形成一个由 2.b 中的日期索引的 pandas 系列，值等于 2.c 中的天数前移的索引。这是一个与我们在第三章中使用的`t1`对象类似的对象。

    1.  计算结果的平均活跃下注，遵循第 10.4 节。

1.  > > 使用来自练习 2.d 的`t1`对象：

    1.  确定最大并发多头下注数量，![](img/Image00096.jpg)。

    1.  确定最大并发空头下注数量，![](img/Image00563.jpg)。

    1.  将下注大小推导为 ![](img/Image00105.jpg)，其中*c [*t* , *l*]*是时间*t*时的并发多头下注数量，*c [*t* , *s*]*是时间*t*时的并发空头下注数量。

1.  > > 使用来自练习 2.d 的`t1`对象：

    1.  计算系列*c [*t*]* = *c [*t* , *l*]* − *c [*t* , *s*]*，其中*c [*t* , *l*]*是时间*t*时的并发多头下注数量，*c [*t* , *s*]*是时间*t*时的并发空头下注数量。

    1.  在 {*c [*t*]* } 上拟合双高斯混合。你可能想使用 López de Prado 和 Foreman [2014] 中描述的方法。

    1.  计算投注大小为 ![](img/Image00107.jpg) ，其中 *F* [*x* ] 是针对值 *x* 的拟合双高斯混合的累计分布函数（CDF）。

    1.  解释此系列 {*m [*t*]* } 如何不同于在练习 3 中计算的投注大小系列。

1.  > > 重复练习 1，其中你使用 `stepSize=.01` ， `stepSize=.05` 和 `stepSize=.1` 来离散化 *m* 。
1.  > > 
1.  > > 重写第 10.6 节中的方程，以便投注大小由幂函数确定，而不是由 sigmoid 函数确定。
1.  > > 
1.  > > 修改代码片段 10.4，以便实现你在练习 6 中推导的方程。

**参考文献**

1.  López de Prado, M. 和 M. Foreman (2014)： “高斯混合方法在数学投资组合监督中的应用：EF3M 算法。” *定量金融* ，第 14 卷，第 5 期，页码 913–930。

1.  Wu, T.，C. Lin 和 R. Weng (2004)： “通过成对耦合进行多类分类的概率估计。” *机器学习研究期刊* ，第 5 卷，页码 975–1005。

**书目**

1.  Allwein, E.，R. Schapire 和 Y. Singer (2001)： “将多类问题简化为二类问题：边际分类器的统一方法。” *机器学习研究期刊* ，第 1 卷，页码 113–141。

1.  Hastie, T. 和 R. Tibshirani (1998)： “通过成对耦合进行分类。” *统计年鉴* ，第 26 卷，第 1 期，页码 451–471。

1.  Refregier, P. 和 F. Vallet (1991)： “神经网络多类分类的概率方法。” 国际人工网络会议论文集，页码 1003–1007。

**注释**

^(1)    参考文献部分列出了一些解释这些概率如何推导的文章。通常这些概率会结合拟合优度或对预测的信心的信息。参见 Wu 等 [2004]，并访问 [`scikit-learn.org/stable/modules/svm.html#scores-and-probabilities`](http://scikit-learn.org/stable/modules/svm.html#scores-and-probabilities) 。

^(2)    当所有结果同样可能时，不确定性是绝对的。

**第十一章**

**回测的危险**

**11.1 动机**

回测是量化工具箱中最重要但却最少被理解的技术之一。一个常见的误解是将回测视为研究工具。研究与回测就像饮酒与驾驶。不要在回测的影响下进行研究。大多数在期刊上发表的回测都有缺陷，因多次测试导致选择偏差（Bailey、Borwein、López de Prado 和 Zhu [2014]; Harvey et al. [2016]）。可以写一本完整的书列出人们在回测过程中所犯的各种错误。尽管我可能是发表回测^(1)和投资绩效指标的学术作者中拥有最多期刊文章的，但我仍然感觉没有精力汇总过去 20 年里看到的所有不同错误。本章并不是回测的速成课程，而是一些即使是经验丰富的专业人士也会犯的常见错误的简短列表。

**11.2 不可能的任务：完美的回测**

在其狭义的定义中，回测是对一项策略在过去某一时期内可能表现的历史模拟。因此，它是一个假设，而绝不是实验。在物理实验室，比如伯克利实验室，我们可以在控制环境变量的情况下重复实验，从而推导出精确的因果关系。相比之下，回测*不是*实验，并且不证明任何事情。回测不能保证任何结果，甚至如果我们能够穿越时空回到过去，也无法确保达到那种夏普比率（Bailey 和 López de Prado [2012]）。随机抽样的结果会有所不同。过去不会重演。

那么，回测的意义何在？它是对多个变量的理性检验，包括下注规模、周转率、对成本的韧性以及在特定情境下的表现。一个好的回测可以非常有帮助，但做好回测却非常困难。在 2014 年，德意志银行的量化团队，在尹罗的带领下，发布了一项题为“量化投资的七大罪恶”（Luo et al. [2014]）的研究。这是一篇非常生动易懂的文章，我建议这个领域的每一个人都仔细阅读。在文中，这个团队提到了常见的偏差：

1.  **幸存者偏差：** 以当前的投资范围为基础，因此忽略了一些公司在过程中破产以及某些证券被摘牌的情况。

1.  **前瞻性偏差：** 使用在模拟决策时并不公开的信息。确保每个数据点的时间戳准确无误。考虑发布日期、分发延迟和补充修正。

1.  **叙事：** 为了证明某种随机模式而事后编造故事。

1.  **数据挖掘和数据窥探：** 在测试集上训练模型。

1.  **交易成本：** 模拟交易成本是困难的，因为唯一能确定这一成本的方法是与交易记录互动（即，进行实际交易）。

1.  **离群值：** 基于过去观察到的一些极端结果制定策略，这些结果可能永远不会再发生。

1.  **做空：** 对现金产品采取空头头寸需要找到借款人。借贷的成本和可用金额通常是未知的，取决于关系、库存、相对需求等。

这些只是大多数期刊发表的论文常见的一些基本错误。其他常见错误包括使用非标准方法计算业绩（第十四章）；忽视隐性风险；只关注收益而忽视其他指标；将相关性与因果关系混淆；选择不具代表性的时间段；未能预见意外情况；忽视强平线或保证金要求的存在；忽视融资成本；以及忘记实用方面（Sarfati [2015]）。还有很多其他错误，但真的，没有必要列举它们，因为接下来的部分标题。

**11.3 即使你的回测完美，它也可能是错误的**

恭喜你！你的回测在每个人都能重现你结果的意义上是完美的，并且你的假设是如此保守，以至于连你的老板都无法反对。你为每一笔交易支付的费用是任何人可能要求的两倍以上。你是在全球一半的人已知信息几个小时后，以极低的参与率执行的。尽管有这些严重的成本，你的回测仍然赚了很多钱。然而，这个完美的回测可能是错误的。为什么？因为只有专家才能生成完美的回测。成为专家意味着你在多年中进行了成千上万次的回测。总之，这并不是你第一次进行回测，因此我们需要考虑到这可能是一次虚假发现，一个在你对同一数据集进行多次测试后不可避免出现的统计异常。

回测令人抓狂的地方在于，你在这方面变得越擅长，出现虚假发现的可能性就越高。初学者会陷入罗等人 [2014] 提出的七大罪恶（还有更多，但谁在计数呢？）。专业人士可能会生成完美的回测，仍然会陷入多重测试、选择偏差或回测过拟合（Bailey 和 López de Prado [2014b]）。

**11.4 回测不是研究工具**

第八章讨论了替代效应、联合效应、掩蔽、MDI、MDA、SFI、并行特征、堆叠特征等。即使某些特征非常重要，也并不意味着可以通过投资策略实现货币化。相反，许多策略看似盈利，尽管它们是基于无关特征的。特征重要性是真正的研究工具，因为它帮助我们理解机器学习算法揭示的模式的性质，无论其是否能货币化。重要的是，特征重要性是*事前*得出的，在历史表现被模拟之前。

相比之下，回测不是研究工具。它对特定策略为何能赚钱几乎没有提供任何见解。就像彩票赢家可能觉得自己做了什么值得的事情来获得运气一样，总是有一些*事后*的故事（罗的罪过第三）。作者们声称发现了数百个“阿尔法”和“因子”，并且总有一些复杂的解释。相反，他们所发现的只是赢得上局游戏的彩票。赢家已经兑现，那些数字对下一轮毫无用处。如果你不愿意为那些彩票支付额外费用，为什么你会在意那些数百个阿尔法呢？这些作者从未告诉我们所有售出的票，即找到这些“幸运”阿尔法所需的数百万次模拟。

回测的目的是剔除糟糕的模型，而不是改进它们。根据回测结果调整模型是浪费时间……而且是危险的。把你的时间和精力投入到确保所有组件正确上，正如我们在书中其他地方讨论的那样：结构化数据、标记、加权、集成、交叉验证、特征重要性、投注规模等。等你进行回测时，已经太晚了。永远不要在模型完全指定之前进行回测。如果回测失败，就重新开始。如果这样做，找到虚假发现的机会将会大幅降低，但仍然不会是零。

**11.5 一些一般性建议**

回测过拟合可以定义为在多个回测中的选择偏差。当一个策略是为了在回测中表现良好而开发时，通过利用随机历史模式，就会发生回测过拟合。因为这些随机模式不太可能在未来再次出现，因此所开发的策略将会失败。每个经过回测的策略都在某种程度上受到“选择偏差”的过拟合：大多数人分享的唯一回测结果是那些展现所谓成功投资策略的。

如何解决回测过拟合可以说是量化金融中最根本的问题。为什么？因为如果这个问题有简单的答案，投资公司就能确定实现高性能，因为它们只会投资于成功的回测。期刊将自信地评估某个策略是否可能是假阳性。金融可能在波普尔和拉卡托斯的意义上成为真正的科学（洛佩斯·德·普拉多 [2017]）。回测过拟合如此难以评估的原因在于，每次对同一数据集进行新的测试时，假阳性的概率都会变化，而这些信息要么研究者不知道，要么不与投资者或审稿人分享。虽然没有简单的方法可以防止过拟合，但一些步骤可以帮助减少其出现。

1.  为整个资产类别或投资领域开发模型，而不是针对特定证券（第八章）。投资者会分散投资，因此他们不会仅在证券 *Y* 上犯错误 *X*。如果你在证券 *Y* 上发现错误 *X*，无论其看似多么有利可图，可能都是一个虚假发现。

1.  应用袋装法（第六章）作为防止过拟合和减少预测误差方差的手段。如果袋装法降低了策略的表现，可能是因为它过拟合了少数观察值或离群值。

1.  在完成所有研究之前不要进行回测（第 1–10 章）。

1.  记录在数据集上进行的每一次回测，以便可以在最终选择结果上估计回测过拟合的概率（见贝利、博温、洛佩斯·德·普拉多和朱 [2017a] 和第十四章），并且夏普比率可以通过进行的试验数量进行适当调整（贝利和洛佩斯·德·普拉多 [2014b]）。

1.  模拟场景而不是历史（第十二章）。标准的回测是历史模拟，容易过拟合。历史只是实现的随机路径，完全可能不同。你的策略应该在广泛的场景下盈利，而不仅仅是轶事性的历史路径。过拟合数千个“如果”场景的结果更困难。

1.  如果回测未能识别出盈利策略，则从头开始。抵制重用那些结果的诱惑。遵循回测第二法则。

> **片段 11.1 马尔科斯的回测第二法则**
> 
> > “在研究时进行回测就像酒后驾驶。不要在回测的影响下进行研究。”
> > 
> > > 马尔科斯·洛佩斯·德·普拉多 *金融机器学习进展*（2018）

**11.6 策略选择**

在第七章中，我们讨论了标签中的序列条件性如何破坏标准的 k 折交叉验证，因为随机抽样会将冗余观察分散到训练集和测试集中。我们必须找到一种不同的（真实的外样本）验证程序：一种在最不可能与用于训练模型的观察相关/冗余的观察上评估我们的模型的程序。有关详细调查，请参见 Arlot 和 Celisse [2010]。

Scikit-learn 实现了一种步进前进的时间折叠方法。² 在这种方法下，测试沿时间方向前进，旨在防止泄漏。这与历史回测（和交易）的一般方式一致。然而，在存在长程序列依赖的情况下，仅在训练集结束前一个观察点进行测试可能不足以避免信息泄漏。我们将在第十二章第 12.2 节重新讨论这一点。

步进前进法的一个缺点是容易过拟合。原因在于如果没有随机抽样，就会有一条可以重复多次的测试路径，直到出现假阳性。与标准的交叉验证一样，需要一些随机化来避免这种绩效目标或回测优化，同时避免将与训练集相关的样本泄漏到测试集中。接下来，我们将介绍一种基于回测过拟合概率估计（PBO）的策略选择交叉验证方法。我们将在第十二章中解释回测的交叉验证方法。

Bailey 等人[2017a]通过组合对称交叉验证（CSCV）方法估计 PBO。示意图如下。

首先，我们通过收集*N*次试验的绩效系列形成一个矩阵*M*。特别地，每一列*n* = 1, …, *N*表示与研究人员尝试的特定模型配置相关的*P&L*（市值利润和损失）在*t* = 1, …, *T*观察下的向量。因此，*M*是一个实值矩阵，阶数为(*T×N*)。我们施加的唯一条件是：(1) *M*是真正的矩阵，即每一列的行数相同，观察在*N*次试验中的每一行都是同步的，(2) 用于选择“最佳”策略的性能评估指标可以在每一列的子样本上进行估计。例如，如果该指标是夏普比率，我们假设在报告的绩效的各个切片上可以保持独立同分布的正态分布假设。如果不同的模型配置以不同的频率交易，观察会被聚合（降采样）以匹配一个公共索引*t* = 1, …, *T*。

其次，我们将*M*按行划分为*个数*S*的相等维度的不相交子矩阵。每个子矩阵*M[*s*]*，其中*s* = 1, …, *S*，的阶数为！[](Image00630.jpg)。

第三，我们形成所有组合 *C [*S*]* 的 *M [*s*]* ，按大小为 ![](img/Image00226.jpg) 的组进行选择。这给出了组合的总数。

![](img/Image00229.jpg)

例如，如果 *S = 16* ，我们将形成 12,780 个组合。每个组合 *c* ∈ *C [*S*]* 由 ![](img/Image00232.jpg) 子矩阵 *M [*s*]* 组成。

第四，对于每个组合 *c* ∈ *C [*S*]* ，我们：

1.  形成 *训练集 J* ，通过连接构成 *c* 的 ![](img/Image00236.jpg) 子矩阵 *M [*s*]* 。*J* 是一个阶数为 ![](img/Image00239.jpg) 的矩阵。

1.  形成 *测试集* ![](img/Image00242.jpg) ，作为 *J* 在 *M* 中的补集。换句话说，![](img/Image00245.jpg) 是由 *M* 中所有不属于 *J* 的行构成的 ![](img/Image00247.jpg) 矩阵。

1.  形成一个阶数为 *N* 的性能统计向量 *R* ，其中 *R* 的第 *n* 项报告与 *J* （训练集）的第 *n* 列相关的性能。

1.  确定元素 *n* * ，使得 ![](img/Image00250.jpg) ，∀*n* = 1, …, *N* 。换句话说，![](img/Image00252.jpg) 。

1.  形成一个阶数为 *N* 的性能统计向量 ![](img/Image00256.jpg) ，其中 ![](img/Image00260.jpg) 的第 *n* 项报告与 ![](img/Image00264.jpg) （测试集）的第 *n* 列相关的性能。

1.  确定 ![](img/Image00267.jpg) 在 ![](img/Image00680.jpg) 中的相对等级。我们将此相对等级表示为 ![](img/Image00271.jpg) ，其中 ![](img/Image00274.jpg) 。这是与在样本 (IS) 中选择的试验相关的样本外 (OOS) 性能的相对等级。如果策略优化过程没有过拟合，我们应该观察到 ![](img/Image00275.jpg) 系统性地优于 ![](img/Image00279.jpg) （OOS），就像 ![](img/Image00282.jpg) 超过了 *R* （IS）。

1.  定义 logit ![](img/Image00286.jpg) 。这展示了 λ [*c*] = 0 的特性，当 ![](img/Image00289.jpg) 与 ![](img/Image00293.jpg) 的中位数重合时。高 logit 值暗示 IS 与 OOS 性能之间的一致性，表明回测过拟合的水平较低。

第五，通过收集所有的 λ [*c*] 来计算 OOS 的等级分布，其中 *c* ∈ *C [*S*]* 。概率分布函数 *f* (λ) 然后被估计为 λ 在所有 *C [*S*]* 中出现的相对频率，带有 ![](img/Image00295.jpg) *。最后，PBO 被估计为 ![](img/Image00298.jpg) ，因为这是与表现不佳的 OOS 的 IS 最优策略相关的概率。

图 11.1 的 x 轴显示最佳策略选择的 Sharpe 比率 IS。y 轴显示该最佳策略选择的 Sharpe 比率 OOS。如可以看出，由于回测过拟合，性能出现强烈且持续的衰退。应用上述算法，我们可以推导与该策略选择过程相关的 PBO，如 图 11.2 所示。

![](img/Image00301.jpg)

**图 11.1** 样本内最佳夏普比率 (SR IS) 与样本外夏普比率 (SR OOS)

![](img/Image00304.jpg)

**图 11.2** 从 logits 分布中推导的回测过拟合概率

每个子集中的观察结果保持原始时间序列。随机抽样是在相对不相关的子集上进行的，而不是在观察结果上。有关该方法准确性的实验分析，请参见 Bailey 等人 [2017a]。

**练习**

1.  > > 一位分析师拟合了一个随机森林分类器，其中一些特征包括季节性调整的就业数据。他将季节性调整后的数据与一月的数据对齐，等等。他犯了什么“罪”？
1.  > > 
1.  > > 一位分析师开发了一种机器学习算法，他利用收盘价生成信号，并在收盘时执行。罪过在哪里？
1.  > > 
1.  > > 美国的游戏厅产生的总收入与授予的计算机科学博士学位之间的相关性为 98.51%。随着博士学位数量的预期增长，我们应该投资游戏厅公司吗？如果不，罪过在哪里？
1.  > > 
1.  > > *华尔街日报* 报道，九月份是年度中唯一一个平均股票收益为负的月份，回顾过去 20、50 和 100 年。我们应该在八月底出售股票吗？如果不，罪过在哪里？
1.  > > 
1.  > > 我们从彭博社下载市盈率，每月对股票进行排名，出售排名前四分之一的股票，并购买排名后四分之一的股票。表现惊人。罪过在哪里？

**参考文献**

1.  Arlot, S. 和 A. Celisse (2010)： “模型选择的交叉验证程序综述。” *统计调查*，第 4 卷，第 40–79 页。

1.  Bailey, D., J. Borwein, M. López de Prado, 和 J. Zhu (2014)： “伪数学与金融骗子：回测过拟合对样本外表现的影响。” *美国数学学会公告*，第 61 卷，第 5 期（五月），第 458–471 页。可在 [`ssrn.com/abstract=2308659`](https://ssrn.com/abstract=2308659) 获取。

1.  Bailey, D., J. Borwein, M. López de Prado, 和 J. Zhu (2017a)： “回测过拟合的概率。” *计算金融杂志*，第 20 卷，第 4 期，第 39–70 页。可在 [`ssrn.com/abstract=2326253`](http://ssrn.com/abstract=2326253) 获取。

1.  Bailey, D. 和 M. López de Prado (2012)： “夏普比率有效前沿。” *风险杂志*，第 15 卷，第 2 期（冬季）。可在 [`ssrn.com/abstract=1821643`](https://ssrn.com/abstract=1821643) 获取。

1.  Bailey, D. 和 M. López de Prado (2014b)： “膨胀夏普比率：修正选择偏差、回测过拟合和非正态性。” *投资组合管理杂志*，第 40 卷，第 5 期，第 94–107 页。可在 [`ssrn.com/abstract=2460551`](https://ssrn.com/abstract=2460551) 获取。

1.  Harvey, C., Y. Liu, 和 H. Zhu (2016)： “. . . 和预期收益的横截面。” *金融研究回顾*，第 29 卷，第 1 期，第 5–68 页。

1.  López de Prado, M. (2017)： “金融作为一门工业科学。” *投资组合管理杂志*，第 43 卷，第 4 期，5–9 页。可在 [`www.iijournals.com/doi/pdfplus/10.3905/jpm.2017.43.4.005`](http://www.iijournals.com/doi/pdfplus/10.3905/jpm.2017.43.4.005) 获取。

1.  Luo, Y., M. Alvarez, S. Wang, J. Jussa, A. Wang 和 G. Rohal (2014)： “量化投资的七大罪恶。” 白皮书，德意志银行市场研究，9 月 8 日。

1.  Sarfati, O. (2015)： “回测：评估策略和避免陷阱的实务指南。” Citi Equity Derivatives。CBOE 2015 风险管理会议。可在 [`www.cboe.com/rmc/2015/olivier-pdf-Backtesting-Full.pdf`](https://www.cboe.com/rmc/2015/olivier-pdf-Backtesting-Full.pdf) 获取。

**参考文献**

1.  Bailey, D., J. Borwein 和 M. López de Prado (2016)： “股票投资组合设计与回测过拟合。” *投资管理杂志*，第 15 卷，第 1 期，1–13 页。可在 [`ssrn.com/abstract=2739335`](https://ssrn.com/abstract=2739335) 获取。

1.  Bailey, D., J. Borwein, M. López de Prado, A. Salehipour 和 J. Zhu (2016)： “金融市场中的回测过拟合。” *自动化交易者*，第 39 卷。可在 [`ssrn.com/abstract=2731886`](https://ssrn.com/abstract=2731886) 获取。

1.  Bailey, D., J. Borwein, M. López de Prado 和 J. Zhu (2017b)： “‘回测过拟合的概率’的数学附录。” *计算金融杂志（风险期刊）*，第 20 卷，第 4 期。可在 [`ssrn.com/abstract=2568435`](https://ssrn.com/abstract=2568435) 获取。

1.  Bailey, D., J. Borwein, A. Salehipour 和 M. López de Prado (2017)： “市场预测者的评估与排名。” *投资管理杂志*，即将出版。可在 [`ssrn.com/abstract=2944853`](https://ssrn.com/abstract=2944853) 获取。

1.  Bailey, D., J. Borwein, A. Salehipour, M. López de Prado 和 J. Zhu (2015)： “在线工具用于展示回测过拟合。” 工作论文。可在 [`ssrn.com/abstract=2597421`](https://ssrn.com/abstract=2597421) 获取。

1.  Bailey, D., S. Ger, M. López de Prado, A. Sim 和 K. Wu (2016)： “统计过拟合与回测表现。” 收录于 *基于风险和因子的投资*，定量金融，Elsevier。可在 [`ssrn.com/abstract=2507040`](https://ssrn.com/abstract=2507040) 获取。

1.  Bailey, D. 和 M. López de Prado (2014a)： “在序列相关性下的止损和‘三重惩罚规则’。” *风险杂志*，第 18 卷，第 2 期，61–93 页。可在 [`ssrn.com/abstract=2201302`](https://ssrn.com/abstract=2201302) 获取。

1.  Bailey, D. 和 M. López de Prado (2015)： “‘在序列相关性下的止损’的数学附录。” *风险杂志*，第 18 卷，第 2 期。可在 [`ssrn.com/abstract=2511599`](https://ssrn.com/abstract=2511599) 获取。

1.  Bailey, D., M. López de Prado, 和 E. del Pozo (2013): “策略批准决策：夏普比率无差异曲线方法。” *算法金融* ，第 2 卷，第 1 期，页码 99–109。可在 [`ssrn.com/abstract=2003638`](https://ssrn.com/abstract=2003638) 获取。

1.  Carr, P. 和 M. López de Prado (2014): “确定最佳交易规则而不进行回测。” 工作论文。可在 [`ssrn.com/abstract=2658641`](https://ssrn.com/abstract=2658641) 获取。

1.  López de Prado, M. (2012a): “投资组合监督：一种进化的方法。” 在康奈尔大学的讲座。可在 [`ssrn.com/abstract=2172468`](https://ssrn.com/abstract=2172468) 获取。

1.  López de Prado, M. (2012b): “锋利的刀刃：非正态收益的绩效评估。” 在康奈尔大学的讲座。可在 [`ssrn.com/abstract=2150879`](https://ssrn.com/abstract=2150879) 获取。

1.  López de Prado, M. (2013): “回测中需要关注的事项。” 在康奈尔大学的讲座。可在 [`ssrn.com/abstract=2308682`](https://ssrn.com/abstract=2308682) 获取。

1.  López de Prado, M. (2014a): “没有回测的最佳交易规则。” 在康奈尔大学的讲座。可在 [`ssrn.com/abstract=2502613`](https://ssrn.com/abstract=2502613) 获取。

1.  López de Prado, M. (2014b): “降低夏普比率。” 在康奈尔大学的讲座。可在 [`ssrn.com/abstract=2465675`](https://ssrn.com/abstract=2465675) 获取。

1.  López de Prado, M. (2015a): “量化元策略。” *实用应用，机构投资者期刊* ，第 2 卷，第 3 期，页码 1–3。可在 [`ssrn.com/abstract=2547325`](https://ssrn.com/abstract=2547325) 获取。

1.  López de Prado, M. (2015b): “经验金融的未来。” *投资组合管理杂志* ，第 41 卷，第 4 期，页码 140–144。可在 [`ssrn.com/abstract=2609734`](https://ssrn.com/abstract=2609734) 获取。

1.  López de Prado, M. (2015c): “回测。” 在康奈尔大学的讲座。可在 [`ssrn.com/abstract=2606462`](https://ssrn.com/abstract=2606462) 获取。

1.  López de Prado, M. (2015d): “经验金融中的近期趋势。” *投资组合管理杂志* ，第 41 卷，第 4 期，页码 29–33。可在 [`ssrn.com/abstract=2638760`](https://ssrn.com/abstract=2638760) 获取。

1.  López de Prado, M. (2015e): “为什么大多数经验发现可能是错误的，以及可以采取的措施。” 在宾夕法尼亚大学的讲座。可在 [`ssrn.com/abstract=2599105`](https://ssrn.com/abstract=2599105) 获取。

1.  López de Prado, M. (2015f): “量化元策略的进展。” 在康奈尔大学的讲座。可在 [`ssrn.com/abstract=2604812`](https://ssrn.com/abstract=2604812) 获取。

1.  López de Prado, M. (2016): “构建超越样本外表现的多元化投资组合。” *投资组合管理杂志* ，第 42 卷，第 4 期，页码 59–69。可在 [`ssrn.com/abstract=2708678`](https://ssrn.com/abstract=2708678) 获取。

1.  López de Prado, M. 和 M. Foreman (2014): “一种高斯混合方法的数学投资组合监督：EF3M 算法。” *定量金融* ，第 14 卷，第 5 期，页码 913–930。可在 [`ssrn.com/abstract=1931734`](https://ssrn.com/abstract=1931734) 获取。

1.  López de Prado, M. 和 A. Peijan (2004): “对冲基金策略损失潜力的测量。” *替代投资期刊* ，第 7 卷，第 1 期，页码 7–31，2004 年夏季。可在 [`ssrn.com/abstract=641702`](https://ssrn.com/abstract=641702) 获取。

1.  López de Prado, M.，R. Vince，和 J. Zhu (2015): “有限投资期限内的风险调整增长投资组合。” 康奈尔大学讲座。可在 [`ssrn.com/abstract=2624329`](https://ssrn.com/abstract=2624329) 获取。

**注意**

^(1)     [`papers.ssrn.com/sol3/cf_dev/AbsByAuth.cfm?per_id=434076`](http://papers.ssrn.com/sol3/cf_dev/AbsByAuth.cfm?per_id=434076) ; [`www.QuantResearch.org/`](http://www.QuantResearch.org/) .

**第十二章**

**通过交叉验证进行回测**

**12.1 动机**

回测使用过去的观察结果评估投资策略的超样本表现。这些过去的观察结果可以通过两种方式使用：（1）在狭义上，模拟投资策略的历史表现，就好像它在过去运行过一样；（2）在广义上，模拟过去没有发生的情景。第一种（狭义）方法，也称为前向行走，普遍到“回测”一词实际上已经成为“历史模拟”的*事实*同义词。第二种（广义）方法则鲜为人知，在本章中我们将介绍一些新的实施方式。每种方法都有其优缺点，都应给予谨慎考虑。

**12.2 前向行走法**

文献中最常见的回测方法是前向行走（WF）方法。WF 是对策略在过去表现的历史模拟。每个策略决策都是基于该决策之前的观察结果。正如我们在第十一章看到的，进行无懈可击的 WF 模拟是一项艰巨的任务，需要对数据源、市场微观结构、风险管理、绩效测量标准（例如，GIPS）、多重测试方法、实验数学等有极高的知识。遗憾的是，没有通用的回测配方。为了准确且具有代表性，每个回测都必须定制以评估特定策略的假设。

WF 享有两个关键优势：（1）WF 具有明确的历史解释。其表现可以与纸上交易相协调。（2）历史是过滤；因此，使用滞后数据确保测试集是样本外的（没有泄漏），只要清除工作得到了正确实施（见第七章，第 7.4.1 节）。在 WF 回测中发现泄漏是一个常见错误，在这里 `t1.index` 落在训练集内，但 `t1.values` 落在测试集内（见第三章）。在 WF 回测中不需要禁运，因为训练集总是早于测试集。

**12.2.1 前向验证方法的陷阱**

WF 存在三个主要缺点：首先，仅测试单一场景（历史路径），容易过拟合（Bailey et al. [2014]）。其次，WF 不一定代表未来表现，因为结果可能受到特定数据点序列的偏见。WF 方法的支持者通常认为预测过去会导致过于乐观的表现估计。然而，常常在反向观察序列上拟合出表现优越的模型会导致表现不佳的 WF 回测。事实上，过拟合前向回测和后向回测同样容易，而观察序列的变化导致不一致的结果就是这种过拟合的证据。如果 WF 的支持者是对的，我们应该观察到后向回测系统地优于前向回测。但事实并非如此，因此支持 WF 的主要论点相对较弱。

为了更清楚地说明这个第二个缺点，假设一个在标普 500 数据上进行 WF 回测的股票策略，从 2007 年 1 月 1 日开始。直到 2009 年 3 月 15 日，涨跌混合将训练策略使其保持市场中性，对每个头寸信心较低。之后，长期上涨将主导数据集，到 2017 年 1 月 1 日，买入预测将占主导地位。若从 2017 年 1 月 1 日向后回放信息，表现会大相径庭（长期上涨后跟随剧烈下跌）。通过利用特定序列，WF 选择的策略可能会让我们陷入困境。

WF 的第三个缺点是初始决策是在总样本的一小部分上做出的。即使设置了热身期，大部分信息仅用于少部分决策。考虑一个热身期的策略，它使用 *t [0]* 的观察值中的 *T.* 这个策略在平均数据点上做出一半的决策 ![](img/Image00307.jpg)。

![](img/Image00311.jpg)

这仅仅是观察值的一个 ![](img/Image00314.jpg) 比例。尽管通过增加热身期可以减轻这个问题，但这样做也会缩短回测的长度。

**12.3 交叉验证方法**

投资者常常询问，如果将策略置于如 2008 年危机、网络泡沫、缩减恐慌或 2015–2016 年中国恐慌等不可预见的压力情境中，策略会表现如何。回答的一种方法是将观察值分为两组，一组是我们希望测试的时间段（测试集），另一组是其余的时间段（训练集）。例如，一个分类器将在 2009 年 1 月 1 日至 2017 年 1 月 1 日的时间段上进行训练，然后在 2008 年 1 月 1 日至 2008 年 12 月 31 日的时间段上进行测试。我们对于 2008 年的性能并不具备历史准确性，因为分类器是在 2008 年之后才可用的数据上进行训练的。但是，测试的目标并不是历史准确性。测试的目的在于将一个*对 2008 年无知*的策略置于如 2008 年的压力情境中。

通过交叉验证（CV）进行回测的目标并不是推导历史准确的表现，而是从多个样本外场景中推断未来表现。对于回测的每个时间段，我们模拟一个分类器的表现，该分类器知道除该时间段以外的一切信息。

**优势**

1.  测试并不是特定（历史）情境的结果。事实上，CV 测试了 *k* 个替代情境，其中只有一个与历史序列相对应。

1.  每个决策都是基于相等大小的集合做出的。这使得在不同时间段之间的结果在决策所用信息量方面可以进行比较。

1.  每个观察值都是一个且仅一个测试集的一部分。没有热身子集，从而实现最长的样本外模拟。

**劣势**

1.  与 WF 类似，模拟了一个单一的回测路径（尽管不是历史路径）。每个观察值生成的预测只有一个且唯一。

1.  CV 并没有明确的历史解释。输出并不模拟策略在过去的表现，而是模拟在各种压力情境下它可能在 *未来* 的表现（这本身就是一个有用的结果）。

1.  由于训练集并不落后于测试集，因此可能会出现信息泄漏。必须非常小心以避免将测试信息泄漏到训练集中。有关如何通过清除和禁运来防止信息泄漏的讨论，请参见第七章。

**12.4 组合清除交叉验证方法**

在这一部分，我将介绍一种新方法，它解决了 WF 和 CV 方法的主要缺点，即这些方案只测试单一路径。我称之为“组合清除交叉验证”（CPCV）方法。考虑研究者所针对的回测路径数量 φ，CPCV 生成所需的训练/测试集组合的精确数量，同时清除包含泄漏信息的训练观察值。

**12.4.1 组合分割**

考虑*T*个观测值划分为*N*个组而不进行洗牌，其中组*n* = 1, …, *N* − 1 的大小为⌊ *T* / *N* ⌋，第*N*组的大小为*T* − ⌊ *T* / *N* ⌋( *N* − 1)，⌊.⌋是向下取整或整数函数。对于大小为*k*组的测试集，可能的训练/测试划分数量为

![](img/Image00317.jpg)

由于每种组合涉及到*k*个测试组，因此测试组的总数为![](img/Image00320.jpg)。而且，由于我们计算了所有可能的组合，这些测试组在所有*N*中是均匀分布的（每个组属于相同数量的训练集和测试集）。这意味着，从*N*组的*k*大小测试集中，我们可以回测总路径数φ[ *N* , *k* ]。

![](img/Image00323.jpg)

图 12.1 说明了*N* = 6 和*k* = 2 时训练/测试划分的组成。存在![](img/Image00326.jpg)个划分，索引为*S1, … ,S15*。对于每个划分，图中用叉号（*x*）标记了包含在测试集中的组，未标记的组则形成训练集。每个组都是φ[6, 2] = 5 个测试集的一部分，因此这个训练/测试划分方案允许我们计算 5 条回测路径。

![](img/Image00330.jpg)

**图 12.1**生成的路径为***φ*** [6, 2] = 5

图 12.2 显示了每个测试组分配到一个回测路径的情况。例如，路径 1 是将来自（*G* 1, *S* 1），(*G* 2, *S* 1），(*G* 3, *S* 2），(*G* 4, *S* 3），(*G* 5, *S* 4）和(*G* 6, *S* 5）的预测结果结合起来的结果。路径 2 则是将来自（*G* 1, *S* 2），(*G* 2, *S* 6），(*G* 3, *S* 6），(*G* 4, *S* 7），(*G* 5, *S* 8）和(*G* 6, *S* 9）的预测结果结合起来的结果，依此类推。

![](img/Image00332.jpg)

**图 12.2**测试组分配到每个 5 条路径

这些路径是通过在每种组合的数据部分θ = 1 − *k* / *N*上训练分类器生成的。虽然理论上可以在部分θ < 1/2 上进行训练，但在实践中我们将假设*k* ≤ *N* /2。训练集中数据的部分θ随着*N* → *T*而增加，但随着*k* → *N* /2 而减少。路径数量φ[ *N* , *k* ]随着*N* → *T*和*k* → *N* /2 而增加。在极限情况下，通过设置*N* = *T*和*k* = *N* /2 = *T* /2 可以实现路径数量的最大值，但这意味着每个组合的分类器仅在一半的数据上进行训练（θ = 1/2）。

**12.4.2 组合清除交叉验证回测算法**

在第七章中，我们介绍了在 CV 上下文中清除和禁止的概念。现在我们将利用这些概念进行回测。CPCV 回测算法如下进行：

1.  将 *T* 个观察值划分为 *N* 组，不进行洗牌，其中组 *n* = 1, …, *N* − 1 的大小为 ⌊*T* /*N* ⌋，第 *N* 组的大小为 *T* − ⌊*T* /*N* ⌋(*N* − 1)。

1.  计算所有可能的训练/测试划分，其中每个划分 *N* − *k* 组构成训练集，*k* 组构成测试集。

1.  对于任何一对标签 (*y [*i*]* , *y [*j*]* )，其中 *y [*i*]* 属于训练集，*y [*j*]* 属于测试集，应用 `PurgedKFold` 类来清除 *y [*i*]*，如果 *y [*i*]* 跨越了用于确定标签 *y [*j*]* 的时间段。该类还会实施禁令，如果某些测试样本早于某些训练样本。

1.  在 ![](img/Image00519.jpg) 训练集上拟合分类器，并在各自的 ![](img/Image00523.jpg) 测试集上生成预测。

1.  计算 φ[*N* , *k* ] 回测路径。你可以从每条路径计算一个夏普比率，并由此推导出策略的夏普比率的经验分布（而不是单个夏普比率，如 WF 或 CV）。

**12.4.3 一些示例**

对于 *k* = 1，我们将获得 φ[ *N* , 1] = 1 条路径，在这种情况下 CPCV 简化为 CV。因此，CPCV 可以理解为 CV 的一种推广，适用于 *k* > 1 *。

对于 *k* = 2，我们将获得 φ[ *N* , 2] = *N* − 1 路径。这是一个特别有趣的情况，因为在大部分数据上训练分类器时，θ = 1 − 2/ *N*，我们几乎可以生成与组数相同的回测路径，即 *N* − 1 *。一个简单的经验法则是将数据划分为 *N* = φ + 1 组，其中 φ 是我们目标的路径数，然后形成 ![](img/Image00367.jpg) 组合。在极限情况下，我们可以将每个观察分配到一个组，*N* = *T*，并生成 φ[ *T* , 2] = *T* − 1 路径，同时在每个组合中训练分类器的数据部分为 θ = 1 − 2/ *T*。

如果需要更多路径，可以将 *k* 增加到 *N* /2，但正如之前所述，这将以使用更小的数据集部分进行训练为代价。在实践中，*k* = 2 通常足以生成所需的 φ 路径，通过设置 *N* = φ + 1 ≤ *T*。

**12.5 组合清除交叉验证如何解决回测过拟合**

给定一个 IID 随机变量样本，*x [*i*]* ∼ *Z*，*i* = 1, …, *I*，其中 *Z* 是标准正态分布，该样本的期望最大值可以近似为

![](img/Image00346.jpg)

其中 *Z ^(− 1)* [.] 是 *Z* 的 CDF 的逆，γ ≈ 0.5772156649⋅⋅⋅ 是欧拉-马歇罗尼常数，且 *I* ≫ 1（见 Bailey et al. [2014] 以获取证明）。现在假设一位研究者在一个表现如马尔可夫链的工具上回测 *I* 个策略，夏普比率为 { *y [*i*]* } [*i* = 1, …, *I*]，E[ *y [*i*]* ] = 0，σ ² [ *y [*i*]* ] > 0，并且 ![](img/Image00432.jpg)。尽管真实的夏普比率为零，我们期望找到一个夏普比率为

![](img/Image00536.jpg)

WF 回测表现出高方差，σ[ *y [*i*]* ] ≫ 0，至少有一个原因：大部分决策基于小部分数据集。一些观察会对夏普比率产生很大影响。使用预热期会缩短回测时间，这可能导致方差更高。WF 的高方差导致虚假发现，因为研究人员会选择最大*估计*夏普比率的回测，即使*真实*夏普比率为零。这就是在 WF 回测中控制试验次数*(I)*的必要原因。没有这些信息，就无法确定家庭错误率(FWER)、虚假发现率(FDR)、回测过拟合概率(PBO，见第十一章)或类似的模型评估统计。

CV 回测（第 12.3 节）通过在数据集的相等且较大部分上训练每个分类器来解决该方差来源。虽然 CV 比 WF 导致更少的虚假发现，但两种方法仍然是从策略*i*、*y [*i*]*的单一路径中估计夏普比率，而这种估计可能非常波动。相比之下，CPCV 从大量路径中推导夏普比率的分布，*j* = 1, …, φ，均值为 E[{ *y [*i* , *j*]* } [*j* = 1, …, φ] ] = μ [*i*]，方差为σ ² [{ *y [*i* , *j*]* } [*j* = 1, …, φ] ] = σ ² [*i*]。CPCV 路径的样本均值方差是

![](img/Image00594.jpg)

其中σ ² [*i*]是策略*i*在路径之间的夏普比率方差，而![](img/Image00832.jpg)是{ *y [*i* ,  *j*] * } [*j*  = 1, …, φ]之间的平均非对角相关性。CPCV 比 CV 和 WF 导致更少的虚假发现，因为![](img/Image00763.jpg)意味着样本均值的方差低于样本的方差，

![](img/Image00552.jpg)

路径越不相关，![](img/Image00555.jpg)，CPCV 的方差就会越小，极限情况下 CPCV 将报告真实的夏普比率 E[ *y [*i*] * ]，方差为零，![](img/Image00845.jpg) *.* 不会有选择偏差，因为从*i* = 1, …, *I*中选择的策略将是具有最高*真实*夏普比率的策略。

当然，我们知道零方差是无法实现的，因为φ有上界，![](img/Image00006.jpg)。尽管如此，对于足够多的路径φ，CPCV 可以使回测的方差小到几乎可以忽略虚假发现的概率。

在第十一章中，我们认为回测过拟合可能是所有数学金融领域中最重要的未解问题。让我们看看 CPCV 如何在实践中帮助解决这个问题。假设一位研究者向期刊提交了一项策略，支持该策略的 WF 回测存在过拟合，从大量未公开的试验中选择。期刊可以要求研究者在给定的*N*和*k*下重复实验，使用 CPCV。由于研究者事先不知道要回测的路径的数量和特征，他的过拟合努力将很容易被击败。该论文将被拒绝或撤回。希望 CPCV 能减少期刊及其他地方发表的虚假发现的数量。

**练习**

1.  > > 假设你在一个期货合约上开发了一个动量策略，预测基于 AR(1)过程。你使用 WF 方法对该策略进行回测，夏普比率为**1.5**。然后你在反向序列上重复回测，获得了**–1.5**的夏普比率。如果有的话，忽略第二个结果的数学依据是什么？
1.  > > 
1.  > > 你在一个期货合约上开发了一个均值回归策略。你的 WF 回测达到了**1.5**的夏普比率。你增加了热身期的长度，结果夏普比率降到了**0.7**。你继续仅呈现较高夏普比率的结果，辩称较短的热身策略更为现实。这是否构成选择偏差？
1.  > > 
1.  > > 你的策略在 WF 回测中达到了**1.5**的夏普比率，但在 CV 回测中只有**0.7**。你继续仅呈现较高夏普比率的结果，辩称 WF 回测在历史上是准确的，而 CV 回测则是情景模拟或推理练习。这是否构成选择偏差？
1.  > > 
1.  > > 你的策略在一段时间内产生了**100,000**个预测。你希望通过生成**1,000**条路径来推导夏普比率的 CPCV 分布。哪些参数组合（*N*，*k*）能让你实现这一目标？
1.  > > 
1.  > > 你发现一个策略在 WF 回测中达到了**1.5**的夏普比率。你撰写了一篇论文，解释可以证明该结果的理论，并提交给一个学术期刊。编辑回复说，有一位评审要求你使用*CPCV*方法重复回测，设置*N*=**100**和*k*=**2**，包括你的代码和完整数据集。你按照这些指示进行，平均夏普比率为**–1**，标准差为**0.5**。你愤怒地不再回复，而是撤回你的提交，并在一个影响因子更高的期刊重新提交。6 个月后，你的论文被接受。你安慰自己的良心，认为如果发现是错误的，那是期刊没有要求进行 CPCV 测试的错。你想：“这不可能不道德，因为这是允许的，大家都这样做。”你有哪些科学或伦理上的论据来为自己的行为辩护？

**参考文献**

1.  Bailey, D. 和 M. López de Prado (2012)： “夏普比率有效前沿。” *风险杂志* ，第 15 卷，第 2 期（冬季）。可在 [`ssrn.com/abstract=1821643`](https://ssrn.com/abstract=1821643) 获取。

1.  Bailey, D. 和 M. López de Prado (2014)： “通胀调整的夏普比率：修正选择偏差、回测过拟合和非正态性。” *投资组合管理杂志* ，第 40 卷，第 5 期，页码 94–107。可在 [`ssrn.com/abstract=2460551`](https://ssrn.com/abstract=2460551) 获取。

1.  Bailey, D.、J. Borwein、M. López de Prado 和 J. Zhu (2014)： “伪数学与金融江湖术士：回测过拟合对样本外表现的影响。” *美国数学学会通告* ，第 61 卷，第 5 期，页码 458–471。可在 [`ssrn.com/abstract=2308659`](http://ssrn.com/abstract=2308659) 获取。

1.  Bailey, D.、J. Borwein、M. López de Prado 和 J. Zhu (2017)： “回测过拟合的概率。” *计算金融杂志* ，第 20 卷，第 4 期，页码 39–70。可在 [`ssrn.com/abstract=2326253`](https://ssrn.com/abstract=2326253) 获取。

**第十三章**

**合成数据的回测**

**13.1 动机**

在本章中，我们将研究一种替代的回测方法，该方法使用历史数据生成具有从观察数据中估计的统计特征的合成数据集。这将使我们能够在大量未见的合成测试集上回测策略，从而减少策略与特定数据点集拟合的可能性。^(1) 这是一个非常广泛的主题，为了深入探讨，我们将重点关注交易规则的回测。

**13.2 交易规则**

投资策略可以定义为假设市场存在非效率的算法。一些策略依赖于计量经济学模型来预测价格，使用如 GDP 或通货膨胀等宏观经济变量；其他策略则利用基本面和会计信息为证券定价，或者寻找衍生品定价中的套利机会等。例如，假设金融中介倾向于在美国财政拍卖前两天出售未发行债券，以筹集购买新“纸张”所需的现金。人们可以利用这一知识，在拍卖前三天出售未发行债券。那么，如何做到呢？每种投资策略都需要实施战术，通常被称为“交易规则”。

对冲基金的风格有几十种，每种风格都运行着几十种独特的投资策略。尽管策略在性质上可能非常异质，但战术相对同质。交易规则提供了进入和退出头寸必须遵循的算法。例如，当策略的信号达到某个值时，将进入一个头寸。退出头寸的条件通常通过盈利和止损的阈值来定义。这些进出规则依赖于通常通过历史模拟进行校准的参数。这种做法导致了*回测过拟合*的问题，因为这些参数针对样本内的特定观察，以至于投资策略与过去紧密相连，从而不适合未来。

一个重要的澄清是，我们关注的是最大化绩效的退出走廊条件。换句话说，头寸已经存在，问题是如何以最佳方式退出。这是执行交易员常常面临的困境，不应与投资证券的进出阈值的确定混淆。有关这个替代问题的研究，请参见 Bertram [2009]。

Bailey 等人 [2014, 2017] 讨论了回测过拟合的问题，并提供了方法来确定模拟绩效在多大程度上可能因过拟合而被夸大。虽然评估回测过拟合的概率是淘汰冗余投资策略的有用工具，但最好还是避免过拟合的风险，至少在校准交易规则的背景下是如此。从理论上讲，这可以通过直接从生成数据的随机过程推导交易规则的最佳参数来实现，而不是进行历史模拟。这就是我们在本章中采取的方法。利用整个历史样本，我们将描述生成观察到的收益流的随机过程，并在不需要历史模拟的情况下推导出交易规则参数的最佳值。

**13.3 问题**

假设投资策略*S*在*i* = 1,… *I*个机会或赌注中进行投资。在每个机会*i*中，*S*持有*m [*i*]*单位的证券*X*，其中*m [*i*]* ∈ (−∞, ∞)。进入该机会的交易价格为*m [*i*] P [*i* , 0]*，其中*P [*i* , 0]*是*m [*i*]*证券交易的每单位平均价格。随着其他市场参与者交易证券*X*，我们可以在观察到的*t*次交易后按市值标记（MtM）机会*i*的价值为*m [*i*] P [*i* , *t*]*。这代表了如果在*t*次交易后以市场观察到的价格清算机会*i*的价值。因此，我们可以计算机会*i*在*t*次交易后的 MtM 利润/亏损为π [*i* , *t*] = *m [*i*]* (*P [*i* , *t*]* − *P [*i* , 0]*）。

标准交易规则提供了在*t* = *T [*i*]*时退出机会*i*的逻辑。这一过程在两个条件之一得到验证时立即发生：

+   ![](img/Image00025.jpg)，其中![](img/Image00571.jpg)是获利平仓阈值。

+   ![](img/Image00062.jpg)，其中![](img/Image00080.jpg)是止损阈值。

这些阈值等同于我们在元标记（第三章）中讨论的水平障碍。因为![](img/Image00582.jpg)，两个退出条件中只能有一个触发机会*i*的退出。假设机会*i*可以在*T [*i*]*时退出，其最终利润/亏损为![](img/Image00585.jpg)。在每个机会开始时，目标是实现预期利润![](img/Image00588.jpg)，其中![](img/Image00593.jpg)是预测价格，*P [*i* , 0]*是机会*i*的入场水平。

> **定义 1：交易规则：** 策略*S*的交易规则由参数集![](img/Image00597.jpg)定义。

一种通过暴力校准交易规则的方法是：

1.  定义一组替代值*R*，Ω：={*R*}。

1.  在不同的*R* ∈ Ω值下模拟历史表现（回测）*S*。

1.  选择最佳*R*。

更正式地：

(13.1) ![](img/Image00600.jpg)

其中 E[.]和σ[.]分别是基于交易规则*R*对![](img/Image00604.jpg)的期望值和标准差，在*i* = 1,… *I*上。换句话说，方程（13.1）最大化了*S*在*I*个机会中替代交易规则*R*空间的夏普比率（参见 Bailey 和 López de Prado [2012]对夏普比率的定义和分析）。由于我们有两个变量来最大化*SR [*R*]*在大小为*I*的样本上，因此容易对*R*进行过拟合。当一对![](img/Image00608.jpg)目标对一些异常值时，发生微不足道的过拟合。Bailey 等人[2017]提供了一个严谨的回测过拟合定义，可以应用于我们对交易规则的研究。

> **定义 2：过拟合交易规则：** *R* * 过拟合当且仅当 ![](img/Image00612.jpg)，其中 *j* = *I* + 1, … *J*，而 Me [Ω] [.]是中位数。

直观上，当一个最优样本内（IS, *i* ∈ [1, *I*]）交易规则 *R* * 预期在样本外（OOS, *j* ∈ [*I* + 1, *J*]）表现不如替代交易规则的中位数时，它就被认为是过拟合。这与我们在第十一章中用来推导 PBO 的定义基本相同。Bailey 等人 [2014] 认为，避免过拟合回测是困难的，特别是当存在能够针对特定观测值 IS 的自由变量，或者Ω中的元素数量很大时。交易规则引入了这样的自由变量，因为 *R* * 可以独立于 *S* 确定。结果是，回测从随机噪声 IS 中获利，使得 *R* * 不适合 OOS 机会。这些作者展示了当Δπ [*i* , *t*] 展现序列依赖时，过拟合会导致 OOS 表现不佳。虽然 PBO 提供了评估回测过拟合程度的有用方法，但避免这个问题在一开始是很方便的。^(2) 为此，我们专门 dedicate 了以下部分。

**13.4 我们的框架**

迄今为止，我们尚未描述观察值π [*i* , *t*] 的随机过程。我们有兴趣寻找一个最优交易规则（OTR），用于那些过拟合最具破坏性的情境，比如当π [*i* , *t*] 显示序列相关性时。具体来说，假设价格服从离散的 Ornstein-Uhlenbeck (O-U) 过程

(13.2) ![](img/Image00647.jpg)

使得随机冲击是独立同分布的 ϵ [*i* , *t*] ∼ *N* (0, 1)。该过程的种子值为 *P [*i* , 0]*，机会 *i* 的目标水平为 ![](img/Image00721.jpg)，而φ决定了 *P [*i* , 0]* 向 ![](img/Image00811.jpg) 收敛的速度。因为π [*i* , *t*] = *m [*i*] * ( *P [*i* , *t*] * − *P [*i* , 0]* )，方程（ 13.2 ）意味着机会 *i* 的表现由过程描述

(13.3)![](img/Image00051.jpg)

从 Bailey 和 López de Prado [2013]的命题 4 的证明可以看出，方程（ 13.2 ）中指定的过程的分布是高斯分布，参数为

(13.4)![](img/Image00142.jpg)

其平稳性的必要和充分条件是φ ∈ ( − 1, 1)。给定一组输入参数{σ, φ}和与机会*i*相关的初始条件![](img/Image00237.jpg)，是否存在 OTR ![](img/Image00327.jpg)？类似地，如果策略*S*预测了一个利润目标![](img/Image00416.jpg)，我们是否可以根据输入值{σ, φ}计算出最优止损![](img/Image00481.jpg)？如果这些问题的答案是肯定的，则不需要进行回测来确定*R*，从而避免了过拟合交易规则的问题。在下一节中，我们将展示如何通过实验回答这些问题。

**13.5 最优交易规则的数值确定**

在上一部分中，我们使用 O-U 模型来描述生成策略*S*回报的随机过程。在本节中，我们将介绍一个程序，以数值方式推导任何规范的一般 OTR，特别是 O-U 规范。

**13.5.1 算法**

算法由五个顺序步骤组成。

+   **步骤 1**：我们通过线性化方程（13.2）来估计输入参数{σ, φ}，如下：

    > > (13.5) ![](img/Image00691.jpg)

然后，我们可以通过排序机会来形成向量*X*和*Y*：

(13.6)![](img/Image00670.jpg)

在方程（13.5）上应用 OLS，我们可以估计原始的 O-U 参数为：

(13.7)![](img/Image00748.jpg)

其中 cov[ ·, ·]是协方差算子。

+   **步骤 2**：我们构建一个止损和获利了结对的网格，![](img/Image00842.jpg)。例如，![](img/Image00079.jpg)和![](img/Image00168.jpg)的笛卡尔积给我们提供 20 × 20 个节点，每个节点构成一个备选交易规则*R* ∈ Ω。

+   **步骤 3**：我们为π [*i* , *t*]生成大量路径（例如，100,000），应用我们的估计![](img/Image00265.jpg)。作为种子值，我们使用与机会*i*相关的观察初始条件![](img/Image00354.jpg)。由于一个头寸不能无限期持有，我们可以施加一个最大持有期（例如，100 个观察值），在此期间即使![](img/Image00437.jpg)也会退出该头寸。这个最大持有期等同于三重障碍法（第三章）的竖线。^(3)

+   **步骤 4**：我们将步骤 3 中生成的 100,000 条路径应用于步骤 2 中生成的每个 20 × 20 网格节点![](img/Image00500.jpg)。对于每个节点，我们应用止损和获利了结逻辑，得到 100,000 个![](img/Image00837.jpg)的值。同样，对于每个节点，我们计算与该交易规则相关的夏普比率，如方程（13.1）所述。请参阅 Bailey 和 López de Prado [2012]，了解夏普比率估计量置信区间的研究。该结果可以通过三种不同方式使用：步骤 5a、步骤 5b 和步骤 5c）。

+   **步骤 5a** : 我们在交易规则网格中确定最优的对 ![](img/Image00686.jpg)，给定输入参数 ![](img/Image00774.jpg) 和观察到的初始条件 ![](img/Image00011.jpg)。

+   **步骤 5b** : 如果策略 *S* 为特定机会 *i* 提供获利目标 ![](img/Image00027.jpg)，我们可以结合步骤 4 的结果使用该信息来确定最佳止损 ![](img/Image00463.jpg)。

+   **步骤 5c** : 如果交易者的最大止损 ![](img/Image00052.jpg) 是基金管理层对机会 *i* 的要求，我们可以结合步骤 4 的结果使用该信息来确定止损范围内的最佳获利 ![](img/Image00482.jpg)。

Bailey 和 López de Prado [2013] 证明方程 ( 13.2 ) 中过程的半衰期为 ![](img/Image00521.jpg)，要求 φ ∈ (0, 1)。根据该结果，我们可以确定与特定半衰期 τ 相关的 φ 值为 ![](img/Image00631.jpg)。

**13.5.2 实现**

Snippet 13.1 提供了本章实验的 Python 实现。函数 `main` 生成参数 ![](img/Image00707.jpg) 的笛卡尔积，这些参数表征方程 (  13.5  ) 中的随机过程。在所有仿真中，我们均使用 σ = 1，而不损失一般性。然后，对于每对 ![](img/Image00799.jpg)，函数 `batch` 计算与各种交易规则相关的 Sharpe 比率。

> **SNIPPET 13.1 确定最佳交易规则的 Python 代码**
> 
> ![](img/Image00033.jpg)

Snippet 13.2 计算了一个 20 × 20 的 Sharpe 比率网格，每个交易规则对应一个 ![](img/Image00126.jpg)，给定一对参数 ![](img/Image00217.jpg)。存在一个垂直障碍，因为最大持有期设置为 100（`maxHP = 100`）。我们将 *P [*i* , 0]* 设为 0，因为是方程 (  13.5  ) 中的距离 ![](img/Image00309.jpg) 驱动了收敛，而不是特定的绝对价格水平。一旦触及三重障碍中的第一个，退出价格将被存储，并开始下一次迭代。完成所有迭代后 (1E5)，可以计算该对的 Sharpe 比率 ![](img/Image00131.jpg)，算法将移至下一对。当所有交易规则对都处理完成后，结果将报告回 `main`。该算法可以并行化，类似于我们在第三章中对三重障碍法所做的。我们将这一任务留作练习。

> **SNIPPET 13.2 确定最佳交易规则的 Python 代码**
> 
> ![](img/Image00469.jpg)

**13.6 实验结果**

表 13.1 列出了本研究中分析的组合。尽管这些输入参数的不同值会产生不同的数值结果，但所应用的组合允许我们分析最一般的情况。“预测”列指的是 ![](img/Image00632.jpg) ; “半衰期”列指的是 τ; “西格玛”列指的是 σ; “maxHP”代表最大持有期。

**表 13.1** **模拟中使用的输入参数组合**

| **图** | **预测** | **半衰期** | **西格玛** | **maxHP** |
| --- | --- | --- | --- | --- |
| 16.1 | 0       | 5       | 1       | 100       |
| 16.2 | 0       | 10       | 1       | 100       |
| 16.3 | 0       | 25       | 1       | 100       |
| 16.4 | 0       | 50       | 1       | 100       |
| 16.5 | 0       | 100       | 1       | 100       |
| 16.6 | 5       | 5       | 1       | 100       |
| 16.7 | 5       | 10       | 1       | 100       |
| 16.8 | 5       | 25       | 1       | 100       |
| 16.9 | 5       | 50       | 1       | 100       |
| 16.10 | 5       | 100       | 1       | 100       |
| 16.11 | 10       | 5       | 1       | 100       |
| 16.12 | 10       | 10       | 1       | 100       |
| 16.13 | 10       | 25       | 1       | 100       |
| 16.14 | 10       | 50       | 1       | 100       |
| 16.15 | 10       | 100       | 1       | 100       |
| 16.16 |  − 5       | 5       | 1       | 100       |
| 16.17 |  − 5       | 10       | 1       | 100       |
| 16.18 |  − 5       | 25       | 1       | 100       |
| 16.19 |  − 5       | 50       | 1       | 100       |
| 16.20 |  − 5       | 100       | 1       | 100       |
| 16.21 |  − 10       | 5       | 1       | 100       |
| 16.22 |  − 10       | 10       | 1       | 100       |
| 16.23 |  − 10       | 25       | 1       | 100       |
| 16.24 |  − 10       | 50       | 1       | 100       |
| 16.25 |  − 10       | 100       | 1       | 100       |

在以下图中，我们绘制了不同利润了结和止损退出条件组合所产生的非年化夏普比率。为了简便起见，我们省略了 y 轴（止损）的负号。夏普比率以灰度表示（颜色较浅表示表现较好；颜色较暗表示表现较差），格式称为热图。性能（ ![](img/Image00652.jpg) ）是按每单位持有计算的（*m [*i*] * = 1），因为其他值的 *m [*i*] * 只是重新缩放了性能，对夏普比率没有影响。交易成本可以很容易地添加，但出于教育目的，最好在没有这些成本的情况下绘制结果，这样您可以欣赏函数的对称性。

**13.6.1 零长期均衡的情况**

零长期均衡的情况与做市商的业务一致，他们在假设价格偏离当前水平将随时间自行修正的情况下提供流动性。τ 越小，自回归系数越小（ ![](img/Image00726.jpg)）。小的自回归系数结合零期望利润的效果是大多数对 ![](img/Image00817.jpg) 的表现为零。

图 13.1 显示了参数组合的热图 ![](img/Image00057.jpg)。半衰期如此之小，以至于性能在小利润和大止损的狭窄组合范围内达到最大。换句话说，**最佳交易规则**是在出现小利润之前，足够长时间持有库存，即使要承受一些 5 倍或 7 倍的未实现损失。夏普比率很高，达到大约 3.2 的水平。这实际上是许多做市商在实践中所做的，与 Easley 等人[2011]描述的“**不对称收益困境**”一致。在这种情况下，最糟糕的交易规则是将短止损与大获利阈值结合，这种情况是做市商在实践中避免的。在网格的对角线上，利润获取和止损是对称的，此时表现最接近中性。当使用三重障碍法（第三章）标记观察时，您应记住这一结果。

![](img/Image00149.jpg)

**图 13.1** 热图 ![](img/Image00243.jpg)

图 13.2 显示，如果我们将 τ 从 5 增加到 10，最高和最低性能的区域在对 ![](img/Image00333.jpg) 的网格上扩散，同时夏普比率降低。这是因为随着半衰期的增加，自回归系数的幅度也增加（回忆一下 ![](img/Image00689.jpg)），使过程更接近随机游走。

![](img/Image00778.jpg)

**图 13.2** 热图 ![](img/Image00015.jpg)

在 图 13.3 中，τ = 25，这再次扩展了最高和最低性能的区域，同时降低了夏普比率。图 13.4 (τ = 50) 和 图 13.5 (τ = 100) 继续这一进展。最终，当 φ → 1 时，没有可识别的区域可以最大化性能。

![](img/Image00108.jpg)

**图 13.3** 热图 ![](img/Image00198.jpg)

![](img/Image00290.jpg)

**图 13.4** 热图 ![](img/Image00384.jpg)

![](img/Image00454.jpg)

**图 13.5** 热图 ![](img/Image00516.jpg)

在历史模拟中，基于随机游走校准交易规则会导致回测过拟合，因为将会选择一个随机的利润兑现和止损组合，这恰好最大化了夏普比率。这就是合成数据回测如此重要的原因：避免因为过去某些统计偶然而选择某个策略（单一路径）。我们的程序通过认识到表现没有一致的模式来防止过拟合，表明没有最佳交易规则。

**13.6.2 长期均衡为正的案例**

长期均衡为正的案例与头寸持有者的业务一致，如对冲基金或资产管理者。图 13.6 显示了参数组合的结果！因为头寸往往盈利，最佳利润兑现高于之前的案例，集中在 6 周围，止损范围在 4 到 10 之间。最佳交易规则的区域呈现出特征性的矩形形状，结合了较宽的止损范围与较窄的利润兑现范围。所有实验中的表现最高，夏普比率约为 12。

![](img/Image00710.jpg)

**图 13.6** 热力图！

在图 13.7 中，我们将半衰期从τ = 5 提高到τ = 10 *.* 现在最佳表现是在以 5 为中心的利润兑现中实现，止损范围在 7 到 10 之间。最佳利润兑现的范围更广，而最佳止损的范围更窄，使得前者的矩形区域更接近正方形。同样，较大的半衰期使得过程更接近随机游走，因此表现相对较低，夏普比率约为 9。

![](img/Image00573.jpg)

**图 13.7** 热力图！

在图 13.8 中，我们设定τ = 25 *.* 现在最佳的利润兑现集中在 3 周围，而最佳的止损范围在 9 到 10 之间。之前的最佳表现的平方区域让位于小利润兑现与大止损阈值的半圆形区域。我们再次看到表现的恶化，夏普比率为 2.7。

![](img/Image00222.jpg)

**图 13.8** 热力图！

在图 13.9 中，半衰期提高到τ = 50 *.* 结果，最佳表现区域扩展，而夏普比率继续下降到 0.8。这与我们在零长期均衡的案例中观察到的效果相同（第 13.6.1 节），不同之处在于现在！因此，没有对称的最差表现区域。

![](img/Image00472.jpg)

**图 13.9** 热图 ![](img/Image00553.jpg)

在 图 13.10 中，我们可以看到 τ = 100 自然得出了上述趋势的结论。该过程现在接近随机游走，最大夏普比率仅为 0.32。

![](img/Image00655.jpg)

**图 13.10** 热图 ![](img/Image00731.jpg)

我们可以在 图 13.11 到 13.15 中观察到类似的模式，其中 ![](img/Image00823.jpg) 和 τ 分别逐渐增加到 5、10、25、50 和 100。

![](img/Image00061.jpg)

**图 13.11** 热图 ![](img/Image00288.jpg)

![](img/Image00708.jpg)

**图 13.12** 热图 ![](img/Image00312.jpg)

![](img/Image00729.jpg)

**图 13.13** 热图 ![](img/Image00488.jpg)

![](img/Image00583.jpg)

**图 13.14** 热图 ![](img/Image00675.jpg)

![](img/Image00578.jpg)

**图 13.15** 热图 ![](img/Image00219.jpg)

**13.6.3 具有负长期均衡的案例**

理性的市场参与者不会在预期损失的假设下开仓。然而，如果交易者意识到损失是一个已有头寸的预期结果，她仍然需要一种策略来平仓，同时尽量减少损失。

我们获得了 图 13.16，这是应用参数 ![](img/Image00086.jpg) 的结果。如果我们将 图 13.16 与 图 13.6 进行比较，似乎一个是另一个的旋转互补。图 13.6 像是 图 13.16 的旋转照片负片。原因在于 图 13.6 的利润在 图 13.16 中变成了损失，而 图 13.6 的损失在 图 13.16 中变成了利润。一个案例是另一个的反转图像，就像赌徒的损失是赌场的收益。

![](img/Image00785.jpg)

**图 13.16** 热图 ![](img/Image00270.jpg)

正如预期，夏普比率为负，最差表现区域集中在止损点 6 附近，获利了结阈值范围在 4 到 10 之间。现在，矩形形状并不对应最佳表现区域，而是对应最差表现区域，夏普比率约为−12。

在 图 13.17 中，τ = 10，现在接近随机游走对我们有利。最差表现区域扩展，矩形区域变为正方形。表现变得不那么负，夏普比率约为−9。

![](img/Image00362.jpg)

**图 13.17** 热图 ![](img/Image00713.jpg)

在图 13.18、13.19 和 13.20 中可以欣赏到这种熟悉的进程，因为 τ 提高到了 25、50 和 100。当过程接近随机游走时，性能趋于平稳，优化交易规则变成了一个回测过拟合的练习。

![](img/Image00166.jpg)

**图 13.18** 热图 ![](img/Image00042.jpg)

![](img/Image00133.jpg)

**图 13.19** 热图 ![](img/Image00227.jpg)

![](img/Image00318.jpg)

**图 13.20** 热图 ![](img/Image00408.jpg)

图 13.21 至 13.25 对 ![](img/Image00475.jpg)和逐步增加的 τ（从 5 增加到 10、25、50 和 100）重复了相同的过程。同样的模式，一个与正的长期均衡案例互补的旋转模式出现了。

![](img/Image00558.jpg)

**图 13.21** 热图 ![](img/Image00659.jpg)

![](img/Image00736.jpg)

**图 13.22** 热图 ![](img/Image00829.jpg)

![](img/Image00066.jpg)

**图 13.23** 热图 ![](img/Image00157.jpg)

![](img/Image00251.jpg)

**图 13.24** 热图 ![](img/Image00340.jpg)

![](img/Image00428.jpg)

**图 13.25** 热图 ![](img/Image00491.jpg)

**13.7 结论**

在本章中，我们展示了如何通过实验确定与遵循离散 O-U 过程的价格相关的最佳交易策略。由于这种交易策略的推导不是基于历史模拟的结果，我们的过程避免了与将回测过拟合于单一路径相关的风险。相反，最佳交易规则是基于推动价格的基础随机过程的特征得出的。相同的方法也可以应用于其他过程，而我们之所以专注于这一特定过程，仅仅是出于教育目的。

虽然我们在本章中没有推导出最佳交易策略问题的闭式解，但我们的实验结果似乎支持以下 OTR 猜想：

> **猜想：** 给定一个以离散 O-U 过程为特征的金融工具价格，存在一个独特的最佳交易规则，其利润获取和止损的组合最大化该规则的夏普比率。

鉴于这些最优交易规则可以在几秒钟内通过数值方法得出，因此几乎没有实际动机去获取封闭形式的解决方案。正如在数学研究中越来越常见的那样，猜想的实验分析可以帮助我们实现目标，即使在没有证明的情况下。如果要证明上述猜想可能需要数年甚至数十年，而迄今为止所有进行的实验都在经验上确认了它。这样说吧：这个猜想是错误的概率相对于你忽视猜想而过度拟合交易规则的概率是微不足道的。因此，理性的行动方案是假设该猜想是正确的，并通过合成数据确定 OTR。在最坏的情况下，交易规则将是次优的，但它几乎肯定会优于一个过度拟合的交易规则。

**练习**

1.  > > 假设你是一个执行交易员。客户给你打电话，要求平仓一个她以 100 的价格进入的空头头寸。她给你两个退出条件：在 90 获利了结和在 105 止损。

    1.  假设客户认为价格遵循 O-U 过程，这些水平合理吗？对于哪些参数？

    1.  你能想到在什么其他随机过程下这些水平是合理的吗？

1.  > > 将 E-mini S&P 500 期货的美元条时间序列拟合到 O-U 过程。给定这些参数：

    1.  制作各种获利了结和止损水平的夏普比率热图。

    1.  OTR 是什么？

1.  > > 在一段美元条的时间序列上重复练习 2，

    1.  10 年期美国国债期货

    1.  WTI 原油期货

    1.  结果是否有显著差异？这是否证明了按产品专业化的执行交易员的必要性？

1.  > > 在将时间序列分为两部分后重复练习 2：

    1.  第一个时间序列截止于 2009 年 3 月 15 日。

    1.  第二个时间序列始于 2009 年 3 月 16 日。

    1.  OTRs 是否有显著差异？

1.  > > 你估计推导出全球 100 个最具流动性期货合约的 OTR 需要多长时间？考虑到练习 4 的结果，你认为你可能需要多频繁地重新校准 OTR？预先计算这些数据是否有意义？
1.  > > 
1.  > > 使用第二十章中描述的`mpEngine`模块并行化片段 13.1 和 13.2。

**参考文献**

1.  Bailey, D. 和 M. López de Prado (2012)： “夏普比率有效前沿。” *风险杂志* ，第 15 卷，第 2 期，3–44 页。可在[`ssrn.com/abstract=1821643`](http://ssrn.com/abstract=1821643)获取。

1.  Bailey, D. 和 M. López de Prado (2013)： “基于回撤的止损和三重惩罚规则。” *风险杂志* ，第 18 卷，第 2 期，61–93 页。可在[`ssrn.com/abstract=2201302`](http://ssrn.com/abstract=2201302)获取。

1.  Bailey, D., J. Borwein, M. López de Prado, 和 J. Zhu (2014): “伪数学与金融江湖术士：回测过拟合对样本外表现的影响。” *美国数学学会通知*，61(5)，页码 458–471\. 可在 [`ssrn.com/abstract=2308659`](http://ssrn.com/abstract=2308659) 获取。

1.  Bailey, D., J. Borwein, M. López de Prado, 和 J. Zhu (2017): “回测过拟合的概率。” *计算金融杂志*，第 20 卷，第 4 期，页码 39–70\. 可在 [`ssrn.com/abstract=2326253`](http://ssrn.com/abstract=2326253) 获取。

1.  Bertram, W. (2009): “最优统计套利交易的解析解决方案。” 工作论文。可在 [`ssrn.com/abstract=1505073`](http://ssrn.com/abstract=1505073) 获取。

1.  Easley, D., M. Lopez de Prado, 和 M. O'Hara (2011): “流动性毒性的交换。” *交易杂志*，第 6 卷，第 2 期，页码 8–13\. 可在 [`ssrn.com/abstract=1748633`](http://ssrn.com/abstract=1748633) 获取。

**笔记**

^(1)    我要感谢彼得·卡尔教授（纽约大学）对本章的贡献。

^(2)    该策略可能仍然是回测过拟合的结果，但至少交易规则不会导致该问题。

^(3)    交易规则 *R* 可以被描述为三种障碍的函数，而不是水平障碍。这一变化对程序没有影响。它只是会为网格增加一个维度（20 × 20 × 20）。在本章中，我们不考虑这一设定，因为这会使该方法的可视化变得不那么直观。

**第十四章**

**回测统计**

**14.1 动机**

在前面的章节中，我们研究了三种回测范式：第一，历史模拟（前进走法，第十一章和第十二章）。第二，情景模拟（CV 和 CPCV 方法，第十二章）。第三，合成数据模拟（第十三章）。无论你选择哪种回测范式，都需要根据一系列统计结果报告，以便投资者用来比较和评估你的策略与竞争对手的表现。在本章中，我们将讨论一些最常用的绩效评估统计数据。其中一些统计数据被包含在全球投资绩效标准（GIPS）中，^(1) 然而，全面的绩效分析需要针对所审查的机器学习策略的特定指标。

**14.2 回测统计类型**

回测统计数据包括投资者用来评估和比较各种投资策略的指标。它们应帮助我们发现策略中可能存在的问题，如显著的不对称风险或低容量。总体而言，它们可以被分类为一般特征、表现、交易/回撤、实施不足、收益/风险效率、分类评分和归因。

**14.3 一般特征**

以下统计数据告诉我们关于回测的一般特征：

+   **时间范围：** 时间范围指定了开始和结束日期。用于测试策略的时间段应足够长，以涵盖全面的市场状态（Bailey 和 López de Prado [2012]）。

+   **平均 AUM：** 这是管理资产的平均美元价值。为了计算这个平均值，长期和短期头寸的美元价值被视为正的实数。

+   **容量：** 策略的容量可以通过最高的 AUM 来衡量，该 AUM 能够实现目标的风险调整表现。需要最低 AUM 以确保适当的下注规模（第十章）和风险分散（第十六章）。超出该最低 AUM，随着 AUM 的增加，表现会因更高的交易成本和较低的周转率而下降。

+   **杠杆：** 杠杆衡量实现报告表现所需的借款金额。如果存在杠杆，必须为其分配成本。测量杠杆的一种方法是将平均头寸规模与平均 AUM 的比率。

+   **最大头寸规模：** 最大头寸规模告诉我们该策略是否在某些时候采取了大大超过平均 AUM 的头寸。一般来说，我们更倾向于那些最大头寸规模接近平均 AUM 的策略，这表明它们不依赖于极端事件的发生（可能是异常值）。

+   **多头比例：** 多头比例显示了下注中涉及多头头寸的比例。在多头-空头的市场中性策略中，理想情况下该值接近 0.5。如果不是，策略可能存在头寸偏差，或者回测的时间段可能过短且不具代表性。

+   **下注频率：** 下注频率是回测中每年下注的次数。连续在同一方向上的头寸被视为同一下注的一部分。当头寸被平仓或翻转至对立方向时，下注结束。下注的数量始终少于交易的数量。交易数量会高估策略发现的独立机会的数量。

+   **平均持有期：** 平均持有期是投注持有的平均天数。高频策略可能持有一个头寸仅为几秒，而低频策略可能持有数月甚至数年。短期持有可能限制策略的能力。持有期与投注频率相关但不同。例如，一种策略可能在每月的非农就业数据发布时下注，每个投注仅持有几分钟。

+   **年化换手率：** 年化换手率测量每年平均交易的美元金额与平均年化资产管理规模（AUM）之间的比例。即使投注数量较少，高换手率也可能发生，因为策略可能需要不断调整头寸。如果每笔交易都涉及在最大多头和最大空头之间转换，即使交易数量较少也可能出现高换手率。

+   **与基础资产的相关性：** 这是策略收益与基础投资范围收益之间的相关性。当相关性显著为正或负时，策略实际上是在持有或卖空投资范围，而没有增加太多价值。

Snippet 14.1 列出了一个算法，该算法从目标头寸的 pandas 系列（`tPos`）推导出平 flattening 或翻转 trades 的时间戳。这为我们提供了发生的投注数量。

> **SNIPPET 14.1 从目标头寸序列推导投注时间**
> 
> ![](img/Image00369.jpg)

Snippet 14.2 说明了一个算法的实现，该算法根据目标头寸的 pandas 系列（`tPos`）估算策略的平均持有期。

> **SNIPPET 14.2 持有期估算器的实现**
> 
> ![](img/Image00676.jpg)

**14.4 性能**

性能统计数据是没有风险调整的美元和收益数字。一些有用的性能测量指标包括：

+   **盈亏（PnL）：** 在整个回测期间产生的总美元金额（或相应的货币等值），包括来自终端头寸的清算成本。

+   **来自多头头寸的盈亏（PnL）：** 完全由多头头寸生成的盈亏美元部分。这是评估多空市场中性策略偏向的有趣数值。

+   **年化收益率：** 包括股息、利息、成本等的时间加权平均年化总收益率。

+   **命中率：** 导致正的盈亏（PnL）的投注比例。

+   **命中带来的平均收益：** 来自产生利润的投注的平均收益。

+   **失误带来的平均收益：** 来自产生亏损的投注的平均收益。

**14.4.1 时间加权收益率**

总收益是来自已实现和未实现的收益和损失的收益率，包括应计利息、支付的息票和测量期的股息。GIPS 规则计算时间加权收益率（TWRR），并调整外部现金流（CFA Institute [2010]）。定期和子定期收益按几何方式链接。对于 2005 年 1 月 1 日或之后开始的周期，GIPS 规则要求计算调整日加权外部现金流的投资组合收益。

我们可以通过确定每个外部现金流时投资组合的价值来计算 TWRR。 ^(2) 投资组合 *i* 在子周期 [ *t* − 1, *t* ] 之间的 TWRR 用 *r [*i* , *t*]* 表示，其公式为

![](img/Image00757.jpg)

其中

+   π [*i* , *t*] 是投资组合 *i* 在时间 *t* 的市值（MtM）利润或损失。

+   *K [*i* , *t*]* 是投资组合 *i* 在子周期 *t* 下管理的资产的市场价值。包含 max{.} 项的目的是为了资助额外的购买（ ramp-up）。

+   *A [*j* , *t*]* 是金融工具 *j* 在时间 *t* 所累积的利息或支付的股息。

+   *P [*j* , *t*]* 是证券 *j* 在时间 *t* 的净价。

+   θ [*i* , *j* , *t*] 是投资组合 *i* 在时间 *t* 对证券 *j* 的持有量。

+   ![](img/Image00852.jpg) 是证券 *j* 在时间 *t* 的脏价。

+   ![](img/Image00089.jpg) 是投资组合 *i* 在证券 *j* 上于子周期 *t* 的平均成交净价。

+   ![](img/Image00177.jpg) 是投资组合 *i* 在证券 *j* 上于子周期 *t* 的平均成交脏价。

现金流入假定在一天开始时发生，而现金流出假定在一天结束时发生。这些子周期收益然后按几何方式链接为

![](img/Image00273.jpg)

变量 φ [*i* , *T*] 可以理解为投资组合 *i* 在其整个生命周期中投资一美元的表现，*t* = 1, …, *T*。最后，投资组合 *i* 的年化收益率为

![](img/Image00368.jpg)

其中 *y [*i*]* 是从 *r [*i* , 1]* 到 *r [*i* , *T*]* 之间经过的年数。

**14.5 连续性**

投资策略很少会产生来自 IID 过程的收益。在缺乏此属性的情况下，策略收益序列会表现出频繁的连续性。连续性是同一符号的收益的不断序列。因此，连续性增加了下行风险，这需要通过适当的指标进行评估。

**14.5.1 收益浓度**

给定一系列来自投注的收益时间序列，{ *r [*t*]* } [*t* = 1, …, *T*]，我们计算两个权重序列，*w ^−* 和 *w ^+*：

![](img/Image00444.jpg)

受到赫芬达尔-赫希曼指数（HHI）的启发，当 || *w ^+* || > 1 时，其中 ||.|| 是向量的大小，我们定义正收益的浓度为

![](img/Image00510.jpg)

当 || *w ^−* || > 1 时，负收益的浓度相应地为

![](img/Image00616.jpg)

根据詹森不等式，我们知道 E[ *r ^+ [*t*]* ] ² ≤ E[( *r [*t*] ^+* ) ² ]。由于 ![](img/Image00694.jpg)，我们推导出 E[ *r ^+ [   *t*   ] * ] ² ≤ E[( *r [*t*] ^(  +  ) * ) ² ] ≤ E[ *r ^+ [   *t*   ] * ] ² || *r ^+ * ||，负投注回报有一个等效边界。这些定义有一些有趣的属性：

1.  0 ≤ *h ^+* ≤ 1

1.  *h ^+* = 0⇔*w ^+ [*t*]* = ||*w ^+* || ^(− 1)，∀*t*（均匀回报）

1.  ![](img/Image00784.jpg)（仅一个非零回报）

我们可以很容易地推导出一个类似的表达式，表示跨月份的投注集中度，*h* [ *t* ]。片段 14.3 实现了这些概念。理想情况下，我们感兴趣的策略是 *bets* 的回报表现出：

+   高夏普比率

+   每年高数量的投注，||*r ^+* || + ||*r ^−* || = *T*

+   高命中率（相对低的 ||*r ^−* ||）

+   低 *h ^+*（没有右侧胖尾）

+   低 *h ^−*（没有左侧胖尾）

+   低 *h* [*t*]（投注没有集中在时间上）

> **片段 14.3 推导 HHI 集中度的算法**
> 
> ![](img/Image00021.jpg)

**14.5.2 回撤和水下时间**

直观地说，回撤（DD）是投资在两个连续高水位（HWM）之间遭受的最大损失。水下时间（TuW）是从高水位到盈亏超过前一个最大盈亏的时间。这些概念通过阅读片段 14.4 可以得到最佳理解。此代码从（1）回报系列（ `dollars = False`）或（2）美元表现系列（ `dollar = True`）推导出 DD 和 TuW 系列。图 14.1 提供了 DD 和 TuW 的示例。

![](img/Image00113.jpg)

**图 14.1** 回撤 (DD) 和水下时间 (TuW) 的示例

> **片段 14.4 推导 DD 和 TuW 的序列**
> 
> ![](img/Image00204.jpg)

**14.5.3 性能评估的运行统计**

一些有用的运行统计测量包括：

+   **正回报的 HHI 指数：** 这是片段 14.3 中的 `getHHI(ret[ret > = 0])`。

+   **负回报的 HHI 指数：** 这是片段 14.3 中的 `getHHI(ret[ret < 0])`。

+   **投注间时间的 HHI 指数：** 这是片段 14.3 中的 `getHHI(ret.groupby` `(pd.TimeGrouper (freq = 'M')).count())`。

+   **95 百分位 DD：** 这是通过片段 14.4 推导的 DD 系列的第 95 百分位。

+   **95 百分位 TuW：** 这是通过片段 14.4 推导的 TuW 系列的第 95 百分位。

**14.6 实施缺口**

投资策略常常由于对执行成本的错误假设而失败。一些重要的测量包括：

+   **每次周转的经纪费用：** 这些是支付给经纪人的费用，包括交易所费用。

+   **每次周转的平均滑点：** 这些是涉及一次投资组合周转的执行成本，不包括经纪费用。例如，包括因在发送订单时以高于中价的成交价购买证券而造成的损失。

+   **每次交易的美元表现：** 这是美元表现（包括佣金费用和滑点成本）与总投资组合周转率之间的比率。它表明，在策略达到盈亏平衡之前，执行的成本可能会变得多么高。

+   **执行成本的回报：** 这是美元表现（包括佣金费用和滑点成本）与总执行成本之间的比率。它应该是一个较大的倍数，以确保策略能在比预期更糟的执行下存活。

**14.7 效率**

到目前为止，所有绩效统计都考虑了利润、损失和成本。在本节中，我们考虑实现这些结果所涉及的风险。

**14.7.1 夏普比率**

假设一个策略的超额收益（超过无风险利率），{*r[*t*]*}[*t* = 1，…，*T*]，是 IID 高斯分布，均值为μ，方差为σ²。夏普比率（SR）定义为

![](img/Image00297.jpg)

SR 的目的是评估特定策略或投资者的技能。由于μ，σ通常是未知的，真实的 SR 值不能确定。不可避免的结果是，夏普比率计算可能会存在相当大的估计误差。

**14.7.2 概率夏普比率**

概率夏普比率（PSR）通过消除由偏斜和/或重尾收益引起的短期序列的通货膨胀效应，提供了对夏普比率（*SR*）的调整估计。给定用户定义的基准^(3)夏普比率（*SR*）和观察到的夏普比率！[](Image00531.jpg)，PSR 估计！[](Image00738.jpg)大于假设的*SR*的概率。根据 Bailey 和 López de Prado [2012]，PSR 可以估计为

![](img/Image00834.jpg)

其中*Z*[.]是标准正态分布的累积分布函数（CDF），*T*是观察到的收益数量，![](img/Image00070.jpg)是收益的偏斜度，![](img/Image00822.jpg)是收益的峰度（对于高斯收益来说为![](img/Image00253.jpg)）。对于给定的*SR*，![](img/Image00358.jpg)随着更大的![](img/Image00776.jpg)（在原始采样频率下，即非年化），或更长的历史记录（*T*），或正偏斜收益（![](img/Image00493.jpg)）而增加，但随着更厚的尾部（![](img/Image00592.jpg)）而减少。图 14.2 绘制了![](img/Image00679.jpg)对于![](img/Image00761.jpg)，![](img/Image00001.jpg)和*SR* = 1.0 作为![](img/Image00094.jpg)和*T*的函数。

![](img/Image00182.jpg)

**图 14.2** PSR 作为偏斜度和样本长度的函数

**14.7.3 通胀调整夏普比率**

通胀调整夏普比率（DSR）是一个 PSR，其中拒绝阈值经过调整以反映试验的多重性。根据 Bailey 和 López de Prado [2014]，DSR 可以估计为！[](Image00277.jpg)，其中基准夏普比率*SR*不再由用户定义。相反，*SR*的估计为

![](img/Image00372.jpg)

其中 ![](img/Image00448.jpg) 是试验估计的 SR 的方差，*N* 是独立试验的数量，*Z* [.] 是标准正态分布的 CDF，γ 是欧拉-马歇罗尼常数，*n* = 1, …, *N*。**图 14.3** 绘制了 *SR* * 作为 ![](img/Image00515.jpg) 和 *N* 的函数。

![](img/Image00622.jpg)

**图 14.3** *SR* * 作为 ![](img/Image00699.jpg) 和 *N* 的函数

DSR 背后的理论是：给定一组 SR 估计值，![](img/Image00789.jpg)，其期望最大值大于零，即使真实的 SR 为零。在零假设下，即实际的夏普比率为零，*H [0]* : *SR* = 0，我们知道期望最大值 ![](img/Image00506.jpg) 可以估算为 *SR* *。事实上，随着更多独立试验的进行 (*N*)，或试验涉及更大的方差 ![](img/Image00117.jpg)，*SR* * 快速增加。根据这些知识，我们推导出回测的第三定律。

> **摘录 14.5 马尔科斯的回测第三定律。金融中的大多数发现都是虚假的，因为其违反了这一原则**
> 
> > “每个回测结果必须与其生成过程中的所有试验一同报告。缺乏这些信息，无法评估回测的‘虚假发现’概率。”
> > 
> > 马尔科斯·洛佩斯·德·普拉多
> > 
> > *金融机器学习的进展* (2018)

**14.7.4 效率统计**

有用的效率统计包括：

+   **年化夏普比率：** 这是通过因子 ![](img/Image00208.jpg) 年化的 SR 值，其中 *a* 是每年观察到的收益平均数。这种常见的年化方法依赖于收益是 IID 的假设。

+   **信息比率：** 这是一个投资组合的 SR 等效指标，用于衡量其相对于基准的表现。它是平均超额收益与跟踪误差之间的年化比率。超额收益被定义为投资组合的收益超过基准收益的部分。跟踪误差被估算为超额收益的标准差。

+   **概率夏普比率：** PSR 修正了由于非正态收益或记录长度引起的通货膨胀效应。它应该超过 0.95，以达到标准的 5% 显著性水平。它可以在绝对收益或相对收益上进行计算。

+   **通胀调整后的夏普比率：** DSR 修正了由于非正态收益、记录长度和多重测试/选择偏差引起的通货膨胀效应。它应该超过 0.95，以达到标准的 5% 显著性水平。它可以在绝对收益或相对收益上进行计算。

**14.8 分类评分**

在元标签策略的背景下（第三章，第 3.6 节），理解 ML 覆盖算法的独立性能是很有用的。请记住，主要算法识别机会，而次要（覆盖）算法决定是否追求这些机会或放弃它们。一些有用的统计数据包括：

+   **准确率：** 准确率是覆盖算法正确标记的机会的比例，

    > > ![](img/Image00727.jpg)

    其中 TP 是真正例的数量，TN 是真负例的数量，FP 是假正例的数量，FN 是假负例的数量。

+   **精确度：** 精确度是预测为正例的样本中真实正例的比例，

    > > ![](img/Image00393.jpg)

+   **召回率：** 召回率是正例中真实正例的比例，

    > > ![](img/Image00458.jpg)

+   **F1：** 对于元标签应用，准确率可能不是一个充分的分类评分。假设在应用元标签后，负样本（标签‘0’）的数量远多于正样本（标签‘1’）。在这种情况下，预测所有样本为负的分类器将获得高准确率，即使召回率=0 且精确度未定义。F1 分数通过评估精确度和召回率的（同等加权）调和平均数来修正这一缺陷，

    > > ![](img/Image00538.jpg)

    顺便提一下，考虑一种不寻常的情况，即在应用元标签后，正例的数量远超过负例。一个将所有样本预测为正例的分类器将达到 TN=0 和 FN=0，因此准确率=精确度和召回率=1。准确率会很高，而 F1 不会小于准确率，即使该分类器无法区分观察样本。一个解决方案是调换正负样本的定义，使得负样本占主导地位，然后用 F1 评分。

+   **负对数损失：** 负对数损失在第九章，第 9.4 节中介绍，涉及超参数调优。请参阅该节以获取详细信息。准确率和负对数损失之间的关键概念区别在于，负对数损失不仅考虑我们的预测是否正确，还考虑这些预测的概率。

请参见第三章，第 3.7 节以获取精确度、召回率和准确率的可视化表示。表 14.1 描述了二分类的四种退化情况。正如你所见，F1 分数在其中两种情况下未定义。因此，当 Scikit-learn 被请求在没有观察到 1 或没有预测到 1 的样本上计算 F1 时，它将打印警告（`UndefinedMetricWarning`），并将 F1 值设为 0。

**表 14.1** **二分类的四种退化情况**

| **条件** | **崩溃** | **准确率** | **精确度** | **召回率** | **F1** |
| --- | --- | --- | --- | --- | --- |
| 观察到所有为 1 | TN=FP=0 | =召回率 | 1 | [0,1] | [0,1] |
| 观察到所有为 0 | TP=FN=0 | [0,1] | 0 | NaN | NaN |
| 预测所有为 1 | TN=FN=0 | =精确度 | [0,1] | 1 | [0,1] |
| 预测所有为 0 | TP=FP=0 | [0,1] | NaN | 0 | NaN |

当所有观察值都是正值（标签‘1’）时，没有真实负例或假阳性，因此精确度为 1，召回率是介于 0 和 1（包括）之间的正实数，准确率等于召回率。然后，![](img/Image00646.jpg)。

当所有预测值都是正值（标签‘1’）时，没有真实负例或假阴性，因此精确度是介于 0 和 1（包括）之间的正实数，召回率为 1，准确率等于精确度。然后，![](img/Image00719.jpg)。

**14.9 归因**

性能归因的目的是根据风险类别分解损益。例如，企业债券投资组合经理通常希望了解其业绩中有多少来自他对以下风险类别的敞口：久期、信用、流动性、经济部门、货币、主权、发行人等。他的久期押注是否获得回报？他在哪些信用细分领域表现出色？还是应该关注他的发行人选择能力？

这些风险并非正交，因此它们之间总是存在重叠。例如，高流动性债券往往具有短久期和高信用评级，通常由大实体以大量美元发行。因此，归因的损益总和将与总损益不匹配，但至少我们将能够计算每个风险类别的夏普比率（或信息比率）。这种方法的最受欢迎示例可能是 Barra 的多因子方法。有关详细信息，请参见 Barra [1998, 2013] 和 Zhang 与 Rachev [2004]。

同样重要的是在每个类别内将 PnL 归因于不同类别。例如，持续时间类别可以分为短期（少于 5 年）、中期（5 到 10 年之间）和长期（超过 10 年）。这种 PnL 归因可以通过以下方式实现：首先，为了避免我们之前提到的重叠问题，我们需要确保投资组合中的每个成员在任何时候都只属于每个风险类别的一个且仅一个类别。换句话说，对于每个风险类别，我们将整个投资组合划分为不相交的部分。其次，对于每个风险类别，我们为每个风险类别形成一个指数。例如，我们将计算短期债券的指数表现、另一个中期债券的指数以及另一个长期债券的指数。每个指数的权重是我们投资组合的重新缩放权重，从而使每个指数的权重总和为 1。第三，我们重复第二步，但这次我们使用来自投资组合（例如 Markit iBoxx 投资级别）的权重来形成这些风险类别指数，同样重新缩放，使每个指数的权重总和为 1。第四，我们计算在这些指数的收益和超额收益上讨论的表现指标。为了清晰起见，在这种情况下，短期指数的超额收益是使用（重新缩放的）投资组合权重（步骤 2）减去使用（重新缩放的）投资组合权重（步骤 3）的收益。

**练习**

1.  > > 一项策略展现出高周转率、高杠杆和大量投注，持有期短，执行成本回报低，同时夏普比率高。它有可能具有大容量吗？你认为这是什么样的策略？
1.  > > 
1.  > > 在 E-mini S&P 500 期货的美元柱数据集上计算。

    1.  正收益的 HHI 指数。

    1.  负收益的 HHI 指数。

    1.  K 线间隔时间的 HHI 指数。

    1.  95 百分位 DD。

    1.  95 百分位 TuW。

    1.  年化平均收益。

    1.  从命中（正收益）中获得的平均收益。

    1.  从失误（负收益）中获得的平均收益。

    1.  年化 SR。

    1.  信息比率，以无风险利率为基准。

    1.  PSR。

    1.  DSR，我们假设进行了 100 次试验，试验的 SR 方差为 0.5。

1.  > > 考虑一种策略，在偶数年做多一个期货合约，在奇数年做空一个期货合约。

    1.  重复练习 2 中的计算。

    1.  与基础资产的相关性是什么？

1.  > > 2 年回测的结果是，月收益的均值为 3.6%，标准差为 0.079%。

    1.  SR 是什么？

    1.  年化 SR 是什么？

1.  > > 继续练习 1：

    1.  收益的偏度为 0，峰度为 3\. PSR 是什么？

    1.  收益的偏度为-2.448，峰度为 10.164\. PSR 是什么？

1.  > > 如果回测长度为 3 年，2.b 的 PSR 将是多少？
1.  > > 
1.  > > 一项为期 5 年的回测的年化 SR 为 2.5，计算基于日收益。偏度为-3，峰度为 10。

    1.  PSR 是什么？

    1.  为了找到最佳结果，进行了 100 次试验。这些试验中夏普比率的方差为 0.5。DSR 是多少？

**参考文献**

1.  Bailey, D. 和 M. López de Prado (2012)： “夏普比率有效前沿。” *风险期刊* , 第 15 卷，第 2 期，页码 3–44。

1.  Bailey, D. 和 M. López de Prado (2014)： “去通胀的夏普比率：修正选择偏差、回测过拟合和非正态性。” *投资组合管理期刊* , 第 40 卷，第 5 期。可在 [`ssrn.com/abstract=2460551`](https://ssrn.com/abstract=2460551) 获取。

1.  Barra (1998)： *风险模型手册：美国股票* , 第 1 版。Barra。可在 [`www.alacra.com/alacra/help/barra_handbook_US.pdf`](http://www.alacra.com/alacra/help/barra_handbook_US.pdf) 获取。

1.  Barra (2013)： *MSCI BARRA 因子指数方法论* , 第 1 版。MSCI Barra。可在 [`www.msci.com/eqb/methodology/meth_docs/MSCI_Barra_Factor%20Indices_Methodology_Nov13.pdf`](https://www.msci.com/eqb/methodology/meth_docs/MSCI_Barra_Factor%20Indices_Methodology_Nov13.pdf) 获取。

1.  CFA Institute (2010)： “全球投资业绩标准。” CFA Institute, 第 2010 卷，第 4 期，二月。可在 [`www.gipsstandards.org/.`](https://www.gipsstandards.org/.) 获取。

1.  Zhang, Y. 和 S. Rachev (2004)： “风险归因与投资组合业绩测量—概述。” 工作论文，加州大学圣巴巴拉分校。可在 [`citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.318.7169`](http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.318.7169) 获取。
